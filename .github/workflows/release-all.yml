name: Release All

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (list PRs without merging)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find and merge release-please PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” Finding release-please PRs..."

          # Function to get current release-please PRs
          get_release_prs() {
            gh pr list \
              --label "autorelease: pending" \
              --state open \
              --json number,title,headRefName \
              --jq '.[] | "\(.number)|\(.title)|\(.headRefName)"'
          }

          PRS=$(get_release_prs)

          if [[ -z "$PRS" ]]; then
            echo "âœ… No release-please PRs found to merge"
            exit 0
          fi

          echo "ğŸ“‹ Found release-please PRs:"
          echo "$PRS" | while IFS='|' read -r number title branch; do
            echo "  - #$number: $title ($branch)"
          done

          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo ""
            echo "ğŸƒ Dry run mode - not merging PRs"
            exit 0
          fi

          echo ""
          echo "ğŸš€ Merging PRs sequentially (with rebase to avoid conflicts)..."

          MERGED_COUNT=0
          FAILED=""

          # Process PRs one at a time, re-fetching the list after each merge
          # to handle any updates from release-please
          while true; do
            # Get fresh list of PRs (in case release-please updated them)
            PRS=$(get_release_prs)

            if [[ -z "$PRS" ]]; then
              break
            fi

            # Get the first PR
            FIRST_PR=$(echo "$PRS" | head -n1)
            IFS='|' read -r number title branch <<< "$FIRST_PR"

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Processing PR #$number: $title"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Update the PR branch with latest main to avoid merge conflicts
            echo "ğŸ“¥ Updating PR branch with latest main..."
            if ! gh pr update-branch "$number" --rebase 2>/dev/null; then
              echo "âš ï¸ Could not rebase, trying merge update..."
              gh pr update-branch "$number" 2>/dev/null || true
            fi

            # Wait a moment for the update to propagate
            sleep 3

            # Now merge the PR
            echo "ğŸ”€ Merging PR #$number..."
            if gh pr merge "$number" --merge --delete-branch; then
              echo "âœ… PR #$number merged successfully"
              MERGED_COUNT=$((MERGED_COUNT + 1))
            else
              echo "âŒ Failed to merge PR #$number"
              FAILED="$FAILED #$number"
              # Break on failure to avoid cascading issues
              break
            fi

            # Wait for main to update and release-please to potentially update other PRs
            echo "â³ Waiting for CI to process..."
            sleep 10
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   Merged: $MERGED_COUNT PRs"

          if [[ -n "$FAILED" ]]; then
            echo "   Failed:$FAILED"
            echo ""
            echo "âš ï¸ Some PRs failed to merge. You may need to resolve conflicts manually."
            exit 1
          fi

          echo ""
          echo "ğŸ‰ All release-please PRs have been merged!"
