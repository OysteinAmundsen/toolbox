{/* API.mdx */}
import { Meta, ArgTypes } from '@storybook/addon-docs/blocks';

<Meta title="Grid/API" />

# API Reference

Complete reference for the `<tbw-grid>` component API.

## Element Tag

```html
<tbw-grid></tbw-grid>
```

The custom element is registered as `tbw-grid` (Toolbox Web Grid).

## Properties

### Core Data Properties

| Property     | Type             | Default | Description                |
| ------------ | ---------------- | ------- | -------------------------- |
| `rows`       | `T[]`            | `[]`    | Array of row data objects  |
| `columns`    | `ColumnConfig[]` | `[]`    | Column configuration array |
| `gridConfig` | `GridConfig<T>`  | `{}`    | Full configuration object  |

### Layout Properties

| Property  | Type                                | Default      | Description            |
| --------- | ----------------------------------- | ------------ | ---------------------- |
| `fitMode` | `'stretch' \| 'fixed'`              | `'stretch'`  | Column sizing strategy |
| `editOn`  | `'click' \| 'dblClick' \| false`    | `'dblClick'` | Edit trigger mode. Set to `false` to disable editing. |

### Read-only Properties

| Property      | Type                      | Description                   |
| ------------- | ------------------------- | ----------------------------- |
| `changedRows` | `Map<T, ChangedRowEntry>` | Rows with pending edits       |
| `sortState`   | `Map<string, SortState>`  | Current sort state per column |

## HTML Attributes

The grid supports configuration via HTML attributes for declarative usage. JSON-serialized values are used for complex types.

| Attribute     | Maps to Property | Type   | Description                           |
| ------------- | ---------------- | ------ | ------------------------------------- |
| `rows`        | `rows`           | JSON   | Row data as JSON array                |
| `columns`     | `columns`        | JSON   | Column config as JSON array           |
| `grid-config` | `gridConfig`     | JSON   | Full config object as JSON            |
| `fit-mode`    | `fitMode`        | string | `'stretch'` or `'fixed'`              |
| `edit-on`     | `editOn`         | string | `'click'`, `'dblClick'`, or `'false'` |

### Example

```html
<tbw-grid
  rows='[{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]'
  columns='[{"field":"id","header":"ID"},{"field":"name","header":"Name"}]'
  fit-mode="stretch"
  edit-on="dblClick"
>
</tbw-grid>
```

> **Note:** JavaScript property assignment takes precedence over HTML attributes. Removing an attribute does not clear a JS-set value.

## Methods

### Data Methods

```typescript
// Update row data
grid.rows = newData;

// Wait for grid to be ready
await grid.ready();

// Force layout recalculation
await grid.forceLayout();

// Get current configuration (readonly)
const config = await grid.getConfig();
```

### Column Methods

```typescript
// Get all columns with visibility info
const columns = grid.getAllColumns();
// Returns: Array<{ field, header, visible, lockVisible? }>

// Show/hide columns
grid.setColumnVisible('fieldName', false);
grid.toggleColumnVisibility('fieldName');
grid.showAllColumns();

// Check column visibility
const isVisible = grid.isColumnVisible('fieldName');

// Reorder columns
grid.setColumnOrder(['id', 'name', 'email']);
const order = grid.getColumnOrder();
```

### Editing Methods

```typescript
// Start bulk/row editing programmatically
await grid.beginBulkEdit(rowIndex);

// Commit active row edit
await grid.commitActiveRowEdit();

// Cancel active row edit
await grid.cancelActiveRowEdit();

// Get pending changes (array of changed rows)
const changes = grid.changedRows;

// Get indices of changed rows
const indices = grid.changedRowIndices;

// Reset changed rows tracking
await grid.resetChangedRows();
```

### Plugin Methods

```typescript
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';

// Get a registered plugin instance
const selection = grid.getPlugin(SelectionPlugin);

// Check if plugin is registered
if (selection) {
  selection.selectAll();
}
```

### Column State Persistence

```typescript
// Get current column state (for saving)
const state = grid.getColumnState();
localStorage.setItem('gridState', JSON.stringify(state));

// Restore column state
const saved = localStorage.getItem('gridState');
if (saved) {
  grid.columnState = JSON.parse(saved);
}

// Reset to initial configuration
grid.resetColumnState();
```

### Shell Methods (Header/Toolbar)

```typescript
// Register a tool panel
grid.registerToolPanel({
  id: 'myPanel',
  title: 'My Panel',
  icon: '⚙️',
  render: (container) => {
    container.innerHTML = '<div>Panel content</div>';
  },
});

// Open/close/toggle the tool panel sidebar
grid.openToolPanel();
grid.closeToolPanel();
grid.toggleToolPanel();

// Toggle specific accordion sections
grid.toggleToolPanelSection('myPanel');

// Check panel state
const isOpen = grid.isToolPanelOpen;
const sections = grid.expandedToolPanelSections;

// Get registered panels
const panels = grid.getToolPanels();
```

## Events

### Edit Events

| Event                | Detail Type        | Cancelable | Description             |
| -------------------- | ------------------ | ---------- | ----------------------- |
| `cell-commit`        | `CellCommitDetail` | ✅ Yes      | Cell value was edited   |
| `row-commit`         | `RowCommitDetail`  | No         | Bulk row edit completed |
| `changed-rows-reset` | -                  | No         | Changed rows were reset |

```typescript
grid.addEventListener('cell-commit', (e: CustomEvent<CellCommitDetail>) => {
  const { row, field, value, oldValue, rowIndex } = e.detail;
  console.log(`Cell ${field} changed from ${oldValue} to ${value}`);

  // Optionally prevent the change
  if (!isValid(value)) {
    e.preventDefault();
  }
});
```

### Sort Events

| Event         | Detail Type        | Description        |
| ------------- | ------------------ | ------------------ |
| `sort-change` | `SortChangeDetail` | Sort state changed |

```typescript
grid.addEventListener('sort-change', (e: CustomEvent<SortChangeDetail>) => {
  const { field, direction, sortState } = e.detail;
  console.log(`Sorted by ${field} ${direction}`);
});
```

### Interaction Events

| Event           | Detail Type          | Cancelable | Description                  |
| --------------- | -------------------- | ---------- | ---------------------------- |
| `activate-cell` | `ActivateCellDetail` | ✅ Yes      | Cell was focused/activated   |
| `column-resize` | `ColumnResizeDetail` | No         | Column was resized           |
| `column-move`   | `ColumnMoveDetail`   | ✅ Yes      | Column was reordered         |
| `group-toggle`  | `GroupToggleDetail`  | No         | Group row expanded/collapsed |

### External Rendering Events

| Event                   | Detail Type           | Description                      |
| ----------------------- | --------------------- | -------------------------------- |
| `mount-external-view`   | `MountExternalDetail` | Request external view renderer   |
| `mount-external-editor` | `MountExternalDetail` | Request external editor renderer |

### Cancelable Events

Some events are **cancelable**, meaning you can call `event.preventDefault()` to stop the default behavior. This enables validation, conditional blocking, and state rollback scenarios.

| Event         | Cancelable | Effect when cancelled                         |
| ------------- | ---------- | --------------------------------------------- |
| `cell-commit` | ✅ Yes      | Value change is rejected; cell keeps old value |
| `activate-cell` | ✅ Yes    | Cell activation is blocked                    |
| `column-move` | ✅ Yes      | Column reorder is reverted to original position |

#### `cell-commit` — Validation Before Save

Use this to validate cell values before they're applied. The event fires **before** the value is written, so calling `preventDefault()` keeps the original value intact.

```typescript
grid.addEventListener('cell-commit', (e: CustomEvent<CellCommitDetail>) => {
  const { field, value, oldValue, row } = e.detail;

  // Example: Prevent negative values in 'salary' field
  if (field === 'salary' && typeof value === 'number' && value < 0) {
    e.preventDefault();
    alert('Salary cannot be negative');
    return;
  }

  // Example: Require manager approval for large changes
  if (field === 'budget' && value > 100000) {
    e.preventDefault();
    showApprovalDialog(row, value);
  }
});
```

#### `activate-cell` — Conditional Cell Activation

Block cell activation (Enter key) based on row/cell state. Useful for preventing interaction with certain cells.

```typescript
grid.addEventListener('activate-cell', (e: CustomEvent<ActivateCellDetail>) => {
  const { row, col } = e.detail;
  const rowData = grid.rows?.[row];

  // Example: Prevent activation on locked rows
  if (rowData?.locked) {
    e.preventDefault();
    return;
  }
});
```

#### `column-move` — Enforce Column Constraints

Prevent column reordering that violates business rules (e.g., keeping grouped columns together).

```typescript
grid.addEventListener('column-move', (e: CustomEvent<ColumnMoveDetail>) => {
  const { field, fromIndex, toIndex } = e.detail;

  // Example: Keep 'id' column always first
  if (field === 'id' || toIndex === 0) {
    e.preventDefault();
    return;
  }
});
```

> **Note:** Non-cancelable events like `sort-change` and `column-resize` are informational—use column-level flags (`sortable: false`, `resizable: false`) to disable those features entirely.

## CSS Custom Properties

See the [Theming](../?path=/docs/grid-theming--docs) page for the complete list of CSS custom properties.

### Quick Reference

```css
tbw-grid {
  /* Colors */
  --tbw-color-bg: #ffffff;
  --tbw-color-fg: #333333;
  --tbw-color-border: #e0e0e0;
  --tbw-color-primary: #1976d2;

  /* Header */
  --tbw-header-bg: #f5f5f5;
  --tbw-header-fg: #333333;

  /* Rows */
  --tbw-row-hover-bg: #f0f7ff;
  --tbw-row-selected-bg: #e3f2fd;

  /* Sizing */
  --tbw-row-height: 36px;
  --tbw-header-height: 40px;
}
```

## CSS Parts

```css
tbw-grid::part(container) {
  /* Main container */
}
tbw-grid::part(header) {
  /* Header row */
}
tbw-grid::part(body) {
  /* Body/rows container */
}
```

## TypeScript Types

### Column Configuration

```typescript
interface ColumnConfig {
  field: string; // Data field key
  header?: string; // Display header text
  type?: ColumnType; // 'string' | 'number' | 'boolean' | 'date' | 'select'
  width?: number; // Width in pixels
  minWidth?: number; // Minimum width
  maxWidth?: number; // Maximum width
  sortable?: boolean; // Enable sorting
  resizable?: boolean; // Enable resizing
  editable?: boolean; // Enable editing
  hidden?: boolean; // Initially hidden
  pinned?: 'left' | 'right'; // Pin to edge
  align?: 'left' | 'center' | 'right';

  // Custom rendering
  formatter?: (value: any, row: T) => string;
  renderer?: (value: any, row: T, cell: HTMLElement) => void;

  // Dynamic cell styling
  cellClass?: (value: any, row: T, column: ColumnConfig) => string[];

  // Select type options
  options?: Array<{ label: string; value: any }>;
}
```

#### cellClass Callback

Apply dynamic CSS classes to individual cells based on cell value, row data, or column configuration.

```typescript
const columns: ColumnConfig[] = [
  {
    field: 'score',
    header: 'Score',
    cellClass: (value, row, column) => {
      if (value < 30) return ['score-low'];
      if (value > 70) return ['score-high'];
      return ['score-medium'];
    },
  },
  {
    field: 'status',
    header: 'Status',
    cellClass: (value) => [`status-${value}`], // e.g., 'status-active', 'status-pending'
  },
];
```

### Grid Configuration

```typescript
interface GridConfig<T> {
  columns?: ColumnConfig[];
  fitMode?: 'stretch' | 'fixed';
  editOn?: 'click' | 'dblClick' | false;
  plugins?: BaseGridPlugin[];
  shell?: ShellConfig;
  animation?: AnimationConfig;

  // Dynamic row styling
  rowClass?: (row: T) => string[];
}
```

#### rowClass Callback

Apply dynamic CSS classes to entire rows based on row data.

```typescript
const config: GridConfig<Employee> = {
  rowClass: (row) => {
    const classes: string[] = [];
    if (!row.active) classes.push('row-inactive');
    if (row.priority === 'high') classes.push('row-priority');
    if (row.role === 'admin') classes.push('row-admin');
    return classes;
  },
};
```

**Notes:**
- Both callbacks return `string[]` (array of class names to apply)
- Empty array `[]` means no dynamic classes
- Classes are automatically cleaned up when row/cell data changes
- Errors in callbacks are caught and logged to console (rendering continues)
- See the [RowClass](?path=/story/grid-core--row-class) and [CellClass](?path=/story/grid-core--cell-class) stories for live demos

### Animation Configuration

The grid supports a global animation configuration that controls whether animations run.
Individual plugins define their own animation styles.

```typescript
// Animation behavior mode
type AnimationMode = boolean | 'on' | 'off' | 'reduced-motion';

// Animation style (used by plugins)
type AnimationStyle = 'slide' | 'fade' | 'flip' | false;

// Grid-level animation config
interface AnimationConfig {
  // Global animation mode (default: 'reduced-motion')
  mode?: AnimationMode;

  // Animation duration in ms (default: 200)
  duration?: number;

  // Easing function (default: 'ease-out')
  easing?: string;

  // Style for sorting row changes (core feature, default: false)
  sort?: AnimationStyle;
}
```

#### Animation Modes

| Mode               | Behavior                                                |
| ------------------ | ------------------------------------------------------- |
| `true` / `'on'`    | Animations always enabled                               |
| `false` / `'off'`  | Animations always disabled                              |
| `'reduced-motion'` | Respects `prefers-reduced-motion` media query (default) |

#### Plugin Animation Styles

Each plugin defines its own animation style in its config:

```typescript
// ReorderPlugin - column reordering animation
new ReorderPlugin({ animation: 'flip' }); // 'flip' | 'fade' | false

// MasterDetailPlugin - expand/collapse animation
new MasterDetailPlugin({ animation: 'slide' }); // 'slide' | 'fade' | false

// TreePlugin - tree node expand/collapse
new TreePlugin({ animation: 'slide' }); // 'slide' | 'fade' | false

// GroupingRowsPlugin - group expand/collapse
new GroupingRowsPlugin({ animation: 'slide' }); // 'slide' | 'fade' | false
```

#### CSS Variables

Animation duration and easing are exposed via CSS custom properties:

```css
tbw-grid {
  --tbw-animation-duration: 200ms;
  --tbw-animation-easing: ease-out;
  --tbw-animation-enabled: 1; /* 0 = disabled, 1 = enabled */
}
```

#### Example

```typescript
grid.gridConfig = {
  // Grid-level: enable animations, set timing
  animation: {
    mode: 'on',
    duration: 300,
    easing: 'ease-in-out',
  },
  // Plugin-level: each plugin configures its own style
  plugins: [
    new ReorderPlugin({ animation: 'flip' }),
    new MasterDetailPlugin({ animation: 'slide' }),
    new TreePlugin({ animation: 'fade' }),
  ],
};
```

### Event Details

```typescript
interface CellCommitDetail<T = any> {
  row: T;
  field: string;
  value: any;
  oldValue: any;
  rowIndex: number;
}

interface SortChangeDetail {
  field: string;
  direction: 'asc' | 'desc' | null;
  sortState: Map<string, SortState>;
}

interface ColumnResizeDetail {
  field: string;
  width: number;
  previousWidth: number;
}
```

## Keyboard Shortcuts

| Shortcut                 | Action                              |
| ------------------------ | ----------------------------------- |
| `↑` `↓` `←` `→`          | Navigate between cells              |
| `Enter`                  | Start editing / confirm edit        |
| `Escape`                 | Cancel editing / clear selection    |
| `Tab` / `Shift+Tab`      | Move to next/previous editable cell |
| `Home` / `End`           | Jump to first/last column           |
| `Ctrl+Home` / `Ctrl+End` | Jump to first/last row              |
| `Page Up` / `Page Down`  | Scroll by page                      |
| `F2`                     | Start editing current cell          |

## Browser Support

The grid uses standard Web Components APIs and is compatible with:

- Chrome/Edge 79+
- Firefox 63+
- Safari 13.1+

No polyfills required for modern browsers.
