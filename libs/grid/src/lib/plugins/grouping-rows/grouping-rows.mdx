import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as GroupingRowsStories from './grouping-rows.stories';

<Meta of={GroupingRowsStories} />

# Row Grouping Plugin

The Row Grouping plugin organizes your rows into collapsible hierarchical groups. Perfect for organizing data by category, department, status, or any other dimensionâ€”or even multiple dimensions for nested grouping.

## Installation

```ts
import { GroupingRowsPlugin } from '@toolbox-web/grid/plugins/grouping-rows';
```

## Basic Usage

The `groupOn` callback receives each row and should return an array representing the group path. For single-level grouping, return a one-element array. For multi-level grouping, return multiple elements (e.g., `['Region', 'Department']`).

<Tabs>
  <Tab label="Vanilla JS">
```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'name', header: 'Employee' },
    { field: 'department', header: 'Department' },
    { field: 'salary', header: 'Salary', type: 'currency' }
  ],
  plugins: [
    new GroupingRowsPlugin({
      groupOn: (row) => [row.department],
      showRowCount: true,
      defaultExpanded: false,
    }),
  ],
};

grid.rows = employees;
```
  </Tab>
  <Tab label="React">
```tsx
import '@toolbox-web/grid-react/features/grouping-rows';
import { DataGrid } from '@toolbox-web/grid-react';

function EmployeeGrid({ employees }) {
  return (
    <DataGrid
      rows={employees}
      columns={[
        { field: 'name', header: 'Employee' },
        { field: 'department', header: 'Department' },
        { field: 'salary', header: 'Salary', type: 'currency' }
      ]}
      groupingRows={{ groupBy: 'department', showRowCount: true }}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```html
<script setup>
import '@toolbox-web/grid-vue/features/grouping-rows';
import { TbwGrid, TbwGridColumn } from '@toolbox-web/grid-vue';

const employees = [
  { name: 'Alice', department: 'Engineering', salary: 95000 },
  { name: 'Bob', department: 'Marketing', salary: 75000 },
  { name: 'Carol', department: 'Engineering', salary: 90000 },
];
</script>

<template>
  <TbwGrid :rows="employees" :grouping-rows="{ groupBy: 'department', showRowCount: true }">
    <TbwGridColumn field="name" header="Employee" />
    <TbwGridColumn field="department" header="Department" />
    <TbwGridColumn field="salary" header="Salary" type="currency" />
  </TbwGrid>
</template>
```
  </Tab>
  <Tab label="Angular">
```typescript
// Feature import - enables the [groupingRows] input
import '@toolbox-web/grid-angular/features/grouping-rows';

import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-employee-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="employees"
      [columns]="columns"
      [groupingRows]="groupingConfig"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class EmployeeGridComponent {
  employees = [/* employee data */];

  columns: ColumnConfig[] = [
    { field: 'name', header: 'Employee' },
    { field: 'department', header: 'Department' },
    { field: 'salary', header: 'Salary', type: 'currency' }
  ];

  groupingConfig = {
    groupOn: (row: any) => [row.department],
    showRowCount: true,
  };
}
```
  </Tab>
</Tabs>

## Demos

### Default Grouping

<Canvas of={GroupingRowsStories.Default} withToolbar />
<Controls of={GroupingRowsStories.Default} />

### Expanded by Default

<Canvas of={GroupingRowsStories.ExpandedByDefault} withToolbar />

### Without Row Count

<Canvas of={GroupingRowsStories.NoRowCount} withToolbar />

## Configuration Options

| Option            | Type                                   | Default   | Description                                              |
| ----------------- | -------------------------------------- | --------- | -------------------------------------------------------- |
| `groupOn`         | `function`                             | -         | Callback returning group path                            |
| `defaultExpanded` | `boolean \| number \| string \| string[]` | `false`   | Initial expanded state (see below)                       |
| `showRowCount`    | `boolean`                              | `true`    | Show count in header                                     |
| `indentWidth`     | `number`                               | `20`      | Indent per level in pixels                               |
| `fullWidth`       | `boolean`                              | `true`    | Group row spans full width                               |
| `animation`       | `false \| 'slide' \| 'fade'`           | `'slide'` | Animation style for expanding/collapsing                 |
| `accordion`       | `boolean`                              | `false`   | Only one group open at a time                            |
| `aggregators`     | `Record<string, AggregatorRef>`        | `{}`      | Aggregators for group summary values                     |

### Default Expanded Options

The `defaultExpanded` option controls which groups are expanded on initial render:

```ts
// Expand all groups
new GroupingRowsPlugin({ defaultExpanded: true, groupOn: ... });

// Collapse all groups (default)
new GroupingRowsPlugin({ defaultExpanded: false, groupOn: ... });

// Expand group at index 0
new GroupingRowsPlugin({ defaultExpanded: 0, groupOn: ... });

// Expand group with specific key
new GroupingRowsPlugin({ defaultExpanded: 'Engineering', groupOn: ... });

// Expand multiple groups by key
new GroupingRowsPlugin({ defaultExpanded: ['Engineering', 'Sales'], groupOn: ... });
```

> **Note:** When using `accordion: true`, prefer `defaultExpanded` with a single value
> (number or string) rather than `true` or an array with multiple values.

### Animation Options

The `animation` option controls how grouped rows appear/disappear:

```ts
// Slide animation (default)
new GroupingRowsPlugin({ animation: 'slide', ... });

// Fade animation
new GroupingRowsPlugin({ animation: 'fade', ... });

// No animation
new GroupingRowsPlugin({ animation: false, ... });
```

> **Note:** Animation respects the grid-level `animation.mode` setting.

### Accordion Mode

In accordion mode, only one group can be expanded at a time. Expanding a group automatically collapses all sibling groups at the same depth level.

<Canvas of={GroupingRowsStories.AccordionMode} withToolbar />

```ts
new GroupingRowsPlugin({
  groupOn: (row) => row.department,
  accordion: true, // Only one group open at a time
});
```

### Aggregators

Display aggregate values (sum, avg, count, min, max, first, last) in group headers. Works in both full-width and per-column rendering modes.

<Canvas of={GroupingRowsStories.WithAggregators} withToolbar />

```ts
new GroupingRowsPlugin({
  groupOn: (row) => row.department,
  aggregators: {
    salary: 'sum',    // Sum of salaries in each group
    bonus: 'avg',     // Average bonus
    id: 'count',      // Count of rows
  },
});
```

**Built-in aggregators:**
- `sum` - Sum of numeric values
- `avg` - Average of numeric values
- `count` - Number of rows
- `min` - Minimum value
- `max` - Maximum value
- `first` - First row's value
- `last` - Last row's value

You can also provide a custom aggregator function:

```ts
aggregators: {
  salary: (rows, field) => {
    const total = rows.reduce((sum, r) => sum + r[field], 0);
    return `$${total.toLocaleString()}`;
  },
}
```

## Multi-Level Grouping

Return multiple values from `groupOn` to create nested group hierarchies:

```ts
new GroupingRowsPlugin({
  groupOn: (row) => [row.region, row.department, row.team],
});
```

## Programmatic API

```ts
const plugin = grid.getPlugin(GroupingRowsPlugin);

// Expand/collapse individual groups by key
plugin.expand('Engineering');
plugin.collapse('Engineering');
plugin.toggle('Engineering');

// Expand/collapse all groups
plugin.expandAll();
plugin.collapseAll();

// Check group state
const isExpanded = plugin.isExpanded('Engineering');
const expandedGroups = plugin.getExpandedGroups();

// Change grouping at runtime
plugin.setGroupOn((row) => [row.region, row.department]);

// Refresh groups (e.g., after data mutation)
plugin.refreshGroups();
```

## Styling

The row grouping plugin supports CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-group-indent-width` | `1.25em` (~20px) | Indentation per group level |
| `--tbw-grouping-rows-bg` | `var(--tbw-color-panel-bg)` | Group row background |
| `--tbw-grouping-rows-bg-hover` | `var(--tbw-color-row-hover)` | Group row hover |
| `--tbw-grouping-rows-toggle-hover` | `var(--tbw-color-row-hover)` | Toggle button hover |
| `--tbw-grouping-rows-count-color` | `var(--tbw-color-fg-muted)` | Count badge color |
| `--tbw-grouping-rows-aggregate-color` | `var(--tbw-color-fg-muted)` | Aggregate value color |
| `--tbw-toggle-size` | `1.25em` | Toggle button size |
| `--tbw-font-size-xs` | `0.7857em` | Count text size |
| `--tbw-animation-duration` | `200ms` | Expand/collapse animation |
| `--tbw-animation-easing` | `ease-out` | Animation curve |

### Example

```css
tbw-grid {
  /* Custom row grouping styling */
  --tbw-group-indent-width: 1.5em; /* Wider indentation */
  --tbw-grouping-rows-bg: #e8f5e9;
  --tbw-grouping-rows-bg-hover: #c8e6c9;
  --tbw-grouping-rows-count-color: #388e3c;
}
```

### CSS Classes

The row grouping plugin uses these class names:

| Class | Element |
| --- | --- |
| `.group-row` | Group header row |
| `.group-toggle` | Expand/collapse button |
| `.group-label` | Group name and value |
| `.group-count` | Row count badge |
| `.group-aggregates` | Container for aggregate values |
| `.group-aggregate` | Individual aggregate value |
| `.tbw-group-slide-in` | Child row slide animation |
| `.tbw-group-fade-in` | Child row fade animation |
| `[data-group-depth="N"]` | Group nesting level (0-4) |
