import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as GroupingRowsStories from './grouping-rows.stories';

<Meta of={GroupingRowsStories} />

# Row Grouping Plugin

The Row Grouping plugin organizes your rows into collapsible hierarchical groups. Perfect for organizing data by category, department, status, or any other dimensionâ€”or even multiple dimensions for nested grouping.

## Installation

```ts
import { GroupingRowsPlugin } from '@toolbox-web/grid/plugins/grouping-rows';
```

## Basic Usage

The `groupOn` callback receives each row and should return an array representing the group path. For single-level grouping, return a one-element array. For multi-level grouping, return multiple elements (e.g., `['Region', 'Department']`).

<Tabs>
  <Tab label="Vanilla JS">
```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'name', header: 'Employee' },
    { field: 'department', header: 'Department' },
    { field: 'salary', header: 'Salary', type: 'currency' }
  ],
  plugins: [
    new GroupingRowsPlugin({
      groupOn: (row) => [row.department],
      showRowCount: true,
      defaultExpanded: false,
    }),
  ],
};

grid.rows = employees;
```
  </Tab>
  <Tab label="React">
```tsx
import { useRef, useEffect } from 'react';
import '@toolbox-web/grid';
import { GroupingRowsPlugin } from '@toolbox-web/grid/plugins/grouping-rows';

function EmployeeGrid({ employees }) {
  const gridRef = useRef(null);

  useEffect(() => {
    if (gridRef.current) {
      gridRef.current.gridConfig = {
        columns: [
          { field: 'name', header: 'Employee' },
          { field: 'department', header: 'Department' },
          { field: 'salary', header: 'Salary', type: 'currency' }
        ],
        plugins: [
          new GroupingRowsPlugin({
            groupOn: (row) => [row.department],
            showRowCount: true,
          }),
        ],
      };
      gridRef.current.rows = employees;
    }
  }, [employees]);

  return <tbw-grid ref={gridRef} />;
}
```
  </Tab>
  <Tab label="Vue">
```vue
<template>
  <tbw-grid ref="gridRef" />
</template>

<script setup>
import { ref, onMounted } from 'vue';
import '@toolbox-web/grid';
import { GroupingRowsPlugin } from '@toolbox-web/grid/plugins/grouping-rows';

const props = defineProps(['employees']);
const gridRef = ref(null);

onMounted(() => {
  gridRef.value.gridConfig = {
    columns: [
      { field: 'name', header: 'Employee' },
      { field: 'department', header: 'Department' },
      { field: 'salary', header: 'Salary', type: 'currency' }
    ],
    plugins: [
      new GroupingRowsPlugin({
        groupOn: (row) => [row.department],
        showRowCount: true,
      }),
    ],
  };
  gridRef.value.rows = props.employees;
});
</script>
```
  </Tab>
  <Tab label="Angular">
```typescript
import { Component, ElementRef, viewChild, effect, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import '@toolbox-web/grid';
import { GroupingRowsPlugin } from '@toolbox-web/grid/plugins/grouping-rows';

@Component({
  standalone: true,
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `<tbw-grid #grid />`
})
export class EmployeeGridComponent {
  gridRef = viewChild<ElementRef>('grid');

  onGrid = effect(() => {
    this.gridRef()?.nativeElement.gridConfig = {
      columns: [
        { field: 'name', header: 'Employee' },
        { field: 'department', header: 'Department' },
        { field: 'salary', header: 'Salary', type: 'currency' }
      ],
      plugins: [
        new GroupingRowsPlugin({
          groupOn: (row) => [row.department],
          showRowCount: true,
        }),
      ],
    };
  });
}
```
  </Tab>
</Tabs>

## Demos

### Default Grouping

<Canvas of={GroupingRowsStories.Default} withToolbar />
<Controls of={GroupingRowsStories.Default} />

### Expanded by Default

<Canvas of={GroupingRowsStories.ExpandedByDefault} withToolbar />

### Without Row Count

<Canvas of={GroupingRowsStories.NoRowCount} withToolbar />

## Configuration Options

| Option            | Type                         | Default   | Description                              |
| ----------------- | ---------------------------- | --------- | ---------------------------------------- |
| `groupOn`         | `function`                   | -         | Callback returning group path            |
| `defaultExpanded` | `boolean`                    | `false`   | Start expanded                           |
| `showRowCount`    | `boolean`                    | `true`    | Show count in header                     |
| `indentWidth`     | `number`                     | `20`      | Indent per level in pixels               |
| `fullWidth`       | `boolean`                    | `true`    | Group row spans full width               |
| `animation`       | `false \| 'slide' \| 'fade'` | `'slide'` | Animation style for expanding/collapsing |

### Animation Options

The `animation` option controls how grouped rows appear/disappear:

```ts
// Slide animation (default)
new GroupingRowsPlugin({ animation: 'slide', ... });

// Fade animation
new GroupingRowsPlugin({ animation: 'fade', ... });

// No animation
new GroupingRowsPlugin({ animation: false, ... });
```

> **Note:** Animation respects the grid-level `animation.mode` setting.

## Multi-Level Grouping

```ts
new RowGroupingPlugin({
  groupByFields: ['region', 'department', 'team'],
});
```

## Programmatic API

```ts
const plugin = grid.getPlugin(RowGroupingPlugin);

plugin.expandGroup(['Engineering']);
plugin.collapseGroup(['Engineering']);
plugin.expandAll();
plugin.collapseAll();
const isExpanded = plugin.isGroupExpanded(['Engineering']);
```

## Styling

The row grouping plugin supports CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-group-indent-width` | `1.25em` (~20px) | Indentation per group level |
| `--tbw-grouping-rows-bg` | `var(--tbw-color-panel-bg)` | Group row background |
| `--tbw-grouping-rows-bg-hover` | `var(--tbw-color-row-hover)` | Group row hover |
| `--tbw-grouping-rows-toggle-hover` | `var(--tbw-color-row-hover)` | Toggle button hover |
| `--tbw-grouping-rows-count-color` | `var(--tbw-color-fg-muted)` | Count badge color |
| `--tbw-toggle-size` | `1.25em` | Toggle button size |
| `--tbw-font-size-xs` | `0.7857em` | Count text size |
| `--tbw-animation-duration` | `200ms` | Expand/collapse animation |
| `--tbw-animation-easing` | `ease-out` | Animation curve |

### Example

```css
tbw-grid {
  /* Custom row grouping styling */
  --tbw-group-indent-width: 1.5em; /* Wider indentation */
  --tbw-grouping-rows-bg: #e8f5e9;
  --tbw-grouping-rows-bg-hover: #c8e6c9;
  --tbw-grouping-rows-count-color: #388e3c;
}
```

### CSS Classes

The row grouping plugin uses these class names:

| Class | Element |
| --- | --- |
| `.group-row` | Group header row |
| `.group-toggle` | Expand/collapse button |
| `.group-label` | Group name and value |
| `.group-count` | Row count badge |
| `.tbw-group-slide-in` | Child row slide animation |
| `.tbw-group-fade-in` | Child row fade animation |
| `[data-group-depth="N"]` | Group nesting level (0-4) |
