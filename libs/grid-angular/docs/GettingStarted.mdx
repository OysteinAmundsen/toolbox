{/* @jsxRuntime automatic */}

import { Meta, Source } from '@storybook/addon-docs/blocks';

<Meta title="Grid/Angular/Getting Started" />

# Getting Started with Angular

The `@toolbox-web/grid-angular` package provides seamless Angular integration for the `<tbw-grid>` data grid component. This guide covers the essential patterns for using the grid effectively in your Angular applications.

## Installation

<Source
  language="bash"
  code={`
# Install both the core grid and Angular adapter
npm install @toolbox-web/grid @toolbox-web/grid-angular

# Or with your preferred package manager
yarn add @toolbox-web/grid @toolbox-web/grid-angular
pnpm add @toolbox-web/grid @toolbox-web/grid-angular
bun add @toolbox-web/grid @toolbox-web/grid-angular
`}
/>

## Setup

Register the grid web component and enable the features you need:

<Source
  language="typescript"
  code={`
// main.ts - Import grid and enable features
import '@toolbox-web/grid';

// Enable features via side-effect imports
// Only import the features you use - this keeps your bundle small!
import '@toolbox-web/grid-angular/features/selection';
import '@toolbox-web/grid-angular/features/editing';
import '@toolbox-web/grid-angular/features/multi-sort';
import '@toolbox-web/grid-angular/features/filtering';
`}
/>

## Basic Usage

The simplest way to use the grid is with the `Grid` directive and feature inputs:

<Source
  language="typescript"
  code={`
// Enable features you use
import '@toolbox-web/grid-angular/features/selection';
import '@toolbox-web/grid-angular/features/editing';
import '@toolbox-web/grid-angular/features/multi-sort';
import '@toolbox-web/grid-angular/features/filtering';

import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

interface Employee {
  id: number;
  name: string;
  department: string;
  salary: number;
}

@Component({
  selector: 'app-employee-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <tbw-grid
      [rows]="employees"
      [columns]="columns"
      [selection]="'range'"
      [editing]="'dblclick'"
      [multiSort]="true"
      [filtering]="{ debounceMs: 200 }"
      style="height: 400px; display: block;"
    />
  \`,
})
export class EmployeeGridComponent {
  employees: Employee[] = [
    { id: 1, name: 'Alice', department: 'Engineering', salary: 95000 },
    { id: 2, name: 'Bob', department: 'Marketing', salary: 75000 },
    { id: 3, name: 'Charlie', department: 'Sales', salary: 85000 },
  ];

  columns: ColumnConfig<Employee>[] = [
    { field: 'id', header: 'ID', type: 'number', width: 70 },
    { field: 'name', header: 'Name', editable: true, sortable: true },
    { field: 'department', header: 'Department', editable: true, sortable: true },
    { field: 'salary', header: 'Salary', type: 'number', format: (v: number) => '$' + v.toLocaleString() },
  ];
}
`}
/>

> **Note**: The `CUSTOM_ELEMENTS_SCHEMA` is required since `<tbw-grid>` is a web component, not an Angular component.

## Feature Input Reference

Each feature input enables a specific plugin with simplified configuration:

| Feature Input | Feature Import | Description |
|---------------|----------------|-------------|
| `[selection]` | `features/selection` | Cell, row, or range selection |
| `[editing]` | `features/editing` | Inline cell editing |
| `[multiSort]` | `features/multi-sort` | Multi-column sorting |
| `[filtering]` | `features/filtering` | Column filtering |
| `[clipboard]` | `features/clipboard` | Copy/paste support |
| `[contextMenu]` | `features/context-menu` | Right-click context menu |
| `[reorder]` | `features/reorder` | Column drag-to-reorder |
| `[visibility]` | `features/visibility` | Column visibility panel |
| `[pinnedColumns]` | `features/pinned-columns` | Sticky left/right columns |
| `[pinnedRows]` | `features/pinned-rows` | Sticky top/bottom rows |
| `[groupingColumns]` | `features/grouping-columns` | Multi-level column headers |
| `[groupingRows]` | `features/grouping-rows` | Row grouping |
| `[columnVirtualization]` | `features/column-virtualization` | Virtualize columns for wide grids |
| `[rowReorder]` | `features/row-reorder` | Row drag-to-reorder |
| `[tree]` | `features/tree` | Hierarchical tree view |
| `[masterDetail]` | `features/master-detail` | Expandable detail rows |
| `[responsive]` | `features/responsive` | Card layout for narrow viewports |
| `[undoRedo]` | `features/undo-redo` | Edit undo/redo |
| `[exportFeature]` | `features/export` | CSV/Excel export |
| `[print]` | `features/print` | Print support |
| `[pivot]` | `features/pivot` | Pivot table functionality |
| `[serverSide]` | `features/server-side` | Server-side data loading |

**Core Config Inputs (no feature import needed):**

| Input | Type | Description |
|-------|------|-------------|
| `[sortable]` | `boolean` | Grid-wide sorting toggle (default: true) |
| `[filterable]` | `boolean` | Grid-wide filtering toggle (default: true). Requires FilteringPlugin. |
| `[selectable]` | `boolean` | Grid-wide selection toggle (default: true). Requires SelectionPlugin. |

**Example shortcuts:**

<Source
  language="html"
  code={`
<!-- Selection modes -->
<tbw-grid [selection]="'cell'" />
<tbw-grid [selection]="'row'" />
<tbw-grid [selection]="'range'" />
<tbw-grid [selection]="{ mode: 'range', checkbox: true }" />

<!-- Editing triggers -->
<tbw-grid [editing]="true" />         <!-- default: dblclick -->
<tbw-grid [editing]="'click'" />
<tbw-grid [editing]="'dblclick'" />
<tbw-grid [editing]="'manual'" />

<!-- Sorting -->
<!-- Single-column sorting is core - columns with sortable: true work without any plugin -->
<tbw-grid [sortable]="true" />        <!-- enable core sorting (default) -->
<tbw-grid [sortable]="false" />       <!-- disable ALL sorting grid-wide -->

<!-- Multi-column sorting (requires features/multi-sort import) -->
<tbw-grid [multiSort]="true" />       <!-- enable multi-column sort -->
<tbw-grid [multiSort]="'single'" />   <!-- limit to single column -->
<tbw-grid [multiSort]="{ maxSortColumns: 3 }" />

<!-- Filtering toggle (requires features/filtering import for plugin) -->
<tbw-grid [filterable]="true" [filtering]="true" />   <!-- enable filtering (default) -->
<tbw-grid [filterable]="false" [filtering]="true" />  <!-- plugin loaded but disabled -->

<!-- Selection toggle (requires features/selection import for plugin) -->
<tbw-grid [selectable]="true" [selection]="'range'" />   <!-- enable selection (default) -->
<tbw-grid [selectable]="false" [selection]="'range'" />  <!-- plugin loaded but disabled -->
`}
/>

## Advanced: Plugin-Based Configuration

For complex scenarios requiring dynamic plugin toggling or advanced configuration, use the plugin-based pattern:

<Source
  language="typescript"
  code={`
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';
import { EditingPlugin } from '@toolbox-web/grid/plugins/editing';
import { MultiSortPlugin } from '@toolbox-web/grid/plugins/multi-sort';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';

@Component({
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <tbw-grid [rows]="employees" [gridConfig]="config" style="height: 400px; display: block;" />
  \`,
})
export class EmployeeGridComponent {
  employees = [/* ... */];

  // Dynamic plugin configuration - useful when plugins need to be toggled at runtime
  config = {
    columns: [
      { field: 'id', header: 'ID', width: 70 },
      { field: 'name', header: 'Name', editable: true, sortable: true },
      { field: 'department', header: 'Department', editable: true },
      { field: 'salary', header: 'Salary', type: 'number' },
    ],
    plugins: [
      new SelectionPlugin({ mode: 'range' }),
      new EditingPlugin({ editOn: 'dblclick' }),
      new MultiSortPlugin(),
      new FilteringPlugin({ debounceMs: 200 }),
    ],
  };
}
`}
/>

## Custom Cell Renderers

Use the `*tbwRenderer` structural directive to customize how cell values are displayed:

<Source
  language="typescript"
  code={`
import { Component, CUSTOM_ELEMENTS_SCHEMA, input } from '@angular/core';
import { Grid, TbwRenderer } from '@toolbox-web/grid-angular';

// Standalone status badge component
@Component({
  selector: 'app-status-badge',
  standalone: true,
  template: \`
    <span [class]="'badge badge--' + status()">
      {{ status() }}
    </span>
  \`,
  styles: \`
    .badge { padding: 4px 8px; border-radius: 4px; }
    .badge--active { background: #22c55e; color: white; }
    .badge--inactive { background: #94a3b8; color: white; }
    .badge--pending { background: #f59e0b; color: black; }
  \`
})
export class StatusBadgeComponent {
  status = input.required<string>();
}

@Component({
  imports: [Grid, TbwRenderer, StatusBadgeComponent],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <tbw-grid [rows]="employees" [gridConfig]="config" style="height: 400px; display: block;">
      <!-- Custom renderer for the status column -->
      <tbw-grid-column field="status">
        <app-status-badge *tbwRenderer="let value" [status]="value" />
      </tbw-grid-column>
    </tbw-grid>
  \`,
})
export class EmployeeGridComponent {
  employees = [
    { id: 1, name: 'Alice', status: 'active' },
    { id: 2, name: 'Bob', status: 'inactive' },
    { id: 3, name: 'Charlie', status: 'pending' },
  ];

  config = {
    columns: [
      { field: 'id', header: 'ID', width: 70 },
      { field: 'name', header: 'Name' },
      { field: 'status', header: 'Status' },
    ],
  };
}
`}
/>

**Renderer Context Variables:**

| Variable | Type | Description |
|----------|------|-------------|
| `$implicit` | `TValue` | The cell value (accessed with `let value`) |
| `row` | `TRow` | The full row data object |
| `column` | `ColumnConfig` | Column configuration |

## Custom Cell Editors

Use the `*tbwEditor` structural directive for inline cell editing. Editor components just need to emit `commit` and `cancel` events - the adapter handles the rest automatically:

<Source
  language="typescript"
  code={`
import { Component, CUSTOM_ELEMENTS_SCHEMA, input, output } from '@angular/core';
import { Grid, TbwRenderer, TbwEditor } from '@toolbox-web/grid-angular';
import { EditingPlugin } from '@toolbox-web/grid/plugins/editing';

// Editor component - emits 'commit' with new value
@Component({
  selector: 'app-status-editor',
  standalone: true,
  template: \`
    <select [value]="value()" (change)="commit.emit($any($event.target).value)">
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
      <option value="pending">Pending</option>
    </select>
  \`,
})
export class StatusEditorComponent {
  value = input<string>();
  commit = output<string>();  // Auto-wired: emitting commits the edit
  cancel = output<void>();    // Auto-wired: emitting cancels the edit
}

@Component({
  imports: [Grid, TbwRenderer, TbwEditor, StatusBadgeComponent, StatusEditorComponent],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <tbw-grid [rows]="employees" [gridConfig]="config" style="height: 400px; display: block;">
      <tbw-grid-column field="status" editable>
        <app-status-badge *tbwRenderer="let value" [status]="value" />
        <app-status-editor *tbwEditor="let value" [value]="value" />
      </tbw-grid-column>
    </tbw-grid>
  \`,
})
export class EmployeeGridComponent {
  employees = [/* ... */];

  config = {
    columns: [
      { field: 'id', header: 'ID', width: 70 },
      { field: 'name', header: 'Name', editable: true },
      { field: 'status', header: 'Status', editable: true },
    ],
    plugins: [new EditingPlugin()],
  };
}
`}
/>

> **Auto-wiring**: The `TbwEditor` directive listens for `commit` and `cancel` events on your component and automatically calls the grid's edit functions. No manual callback binding needed!

## Handling Events

Listen to grid events using standard Angular event binding:

<Source
  language="typescript"
  code={`
@Component({
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <tbw-grid
      [rows]="employees"
      [gridConfig]="config"
      (cell-click)="onCellClick($event)"
      (row-click)="onRowClick($event)"
      (cell-commit)="onCellCommit($event)"
      (sort-change)="onSortChange($event)"
    />
  \`,
})
export class EmployeeGridComponent {
  onCellClick(event: CustomEvent) {
    const { row, column, value } = event.detail;
    console.log('Cell clicked:', { row, column, value });
  }

  onRowClick(event: CustomEvent) {
    const { row, rowIndex } = event.detail;
    console.log('Row clicked:', row);
  }

  onCellCommit(event: CustomEvent) {
    const { row, column, newValue, oldValue } = event.detail;
    console.log('Cell edited:', { row, column, newValue, oldValue });
  }

  onSortChange(event: CustomEvent) {
    const { sortState } = event.detail;
    console.log('Sort changed:', sortState);
  }
}
`}
/>

## Programmatic Grid Access

Access the grid element directly for programmatic control:

<Source
  language="typescript"
  code={`
import { Component, CUSTOM_ELEMENTS_SCHEMA, ElementRef, viewChild } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { DataGridElement } from '@toolbox-web/grid';

@Component({
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <button (click)="refreshGrid()">Refresh</button>
    <button (click)="exportCsv()">Export CSV</button>
    <tbw-grid #grid [rows]="employees" [gridConfig]="config" />
  \`,
})
export class EmployeeGridComponent {
  grid = viewChild<ElementRef<DataGridElement>>('grid');

  refreshGrid() {
    this.grid()?.nativeElement.forceLayout();
  }

  async exportCsv() {
    const exportPlugin = this.grid()?.nativeElement.getPlugin(ExportPlugin);
    await exportPlugin?.exportToCsv({ filename: 'employees.csv' });
  }
}
`}
/>

## Type-Level Defaults

Register application-wide renderers and editors for specific data types using `provideGridTypeDefaults()`:

<Source
  language="typescript"
  code={`
// app.config.ts
import { ApplicationConfig } from '@angular/core';
import { provideGridTypeDefaults } from '@toolbox-web/grid-angular';
import { CurrencyRendererComponent, DateRendererComponent } from './renderers';

export const appConfig: ApplicationConfig = {
  providers: [
    provideGridTypeDefaults({
      currency: {
        renderer: CurrencyRendererComponent,
      },
      date: {
        renderer: DateRendererComponent,
      },
    }),
  ],
};

// Now any column with type: 'currency' uses CurrencyRendererComponent automatically
// config = {
//   columns: [
//     { field: 'salary', header: 'Salary', type: 'currency' },  // Uses CurrencyRenderer
//     { field: 'hireDate', header: 'Hire Date', type: 'date' }, // Uses DateRenderer
//   ],
// };
`}
/>

## Variable Row Heights

The grid supports variable row heights for complex layouts with wrapped text or dynamic content. Configure via `gridConfig.rowHeight`:

<Source
  language="typescript"
  code={`
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { GridConfig } from '@toolbox-web/grid';

@Component({
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <tbw-grid [rows]="employees" [gridConfig]="config" style="height: 400px; display: block;" />
  \`,
})
export class VariableHeightGridComponent {
  employees = [/* ... */];

  config: GridConfig = {
    rowId: 'id', // Required for height caching when rows are recreated
    rowHeight: (row, index) => {
      // Return known fixed height when possible (fast)
      if (row.type === 'header') return 48;

      // Return undefined to auto-measure the row's DOM height (slower)
      return row.hasLongDescription ? undefined : 28;
    },
    columns: [/* ... */],
  };
}
`}
/>

### Height Caching

The grid caches measured heights to avoid repeated DOM measurements. When rows may be recreated (e.g., from HTTP responses), use `rowId` to maintain cache identity:

<Source
  language="typescript"
  code={`
config: GridConfig = {
  rowId: 'id',  // Use the 'id' field as unique identifier
  rowHeight: (row) => row.expanded ? undefined : 32,
};
`}
/>

### Plugin-Provided Heights

Plugins like `GroupingRowsPlugin` provide their own row heights. Configure via the plugin's options:

<Source
  language="typescript"
  code={`
import { GroupingRowsPlugin } from '@toolbox-web/grid/all';

config: GridConfig = {
  plugins: [
    new GroupingRowsPlugin({
      field: 'department',
      groupRowHeight: 36, // Known height for group headers
    }),
  ],
  // Your rowHeight callback handles data rows only -
  // plugins handle their own synthetic rows automatically
  rowHeight: (row) => row.hasNotes ? undefined : 28,
};
`}
/>

See [Variable Row Heights](/docs/grid-core--docs#variable-row-heights) for complete documentation.

## Feature-Scoped Inject Functions

Feature imports also export **scoped inject functions** for programmatic access to plugin functionality. These functions provide type-safe access to plugin methods without needing direct plugin references.

### Export Inject Function

<Source
  language="typescript"
  code={`
import '@toolbox-web/grid-angular/features/export';
import { injectGridExport } from '@toolbox-web/grid-angular/features/export';
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';

@Component({
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: \`
    <div class="toolbar">
      <button (click)="exportCsv()" [disabled]="gridExport.isExporting()">
        Export CSV
      </button>
      <button (click)="exportExcel()" [disabled]="gridExport.isExporting()">
        Export Excel
      </button>
    </div>
    <tbw-grid [rows]="employees" [columns]="columns" [export]="true" />
  \`,
})
export class ExportGridComponent {
  employees = [/* ... */];
  columns = [/* ... */];

  // Feature-scoped inject function - type-safe and tree-shakeable
  gridExport = injectGridExport();

  exportCsv() {
    this.gridExport.exportToCsv('employees.csv');
  }

  exportExcel() {
    this.gridExport.exportToExcel('employees.xlsx');
  }
}
`}
/>

### Why Use Feature-Scoped Inject Functions?

1. **Cleaner imports** - Inject function comes from the same feature import
2. **Type safety** - Returns only methods relevant to that feature
3. **Tree-shakeable** - Only pay for what you import
4. **No plugin reference needed** - Works via injection context internally

### Available Feature Inject Functions

| Function | Import | Returns |
|----------|--------|---------|
| `injectGridExport()` | `features/export` | `exportToCsv`, `exportToExcel`, `exportToJson`, `isExporting` |

> **More inject functions coming soon** - Selection, filtering, and other features will get scoped inject functions in future releases.

### Comparison with injectGrid

<Source
  language="typescript"
  code={`
// ❌ Verbose: Getting export methods via injectGrid
import { injectGrid } from '@toolbox-web/grid-angular';
import { ExportPlugin } from '@toolbox-web/grid/plugins/export';

const grid = injectGrid();
// Need to get plugin instance and call methods on it
const plugin = grid.element()?.getPlugin(ExportPlugin);
plugin?.exportToCsv('data.csv');

// ✅ Clean: Feature-scoped inject function
import { injectGridExport } from '@toolbox-web/grid-angular/features/export';

const gridExport = injectGridExport();
gridExport.exportToCsv('data.csv');
`}
/>

## Next Steps

- **[Reactive Forms Integration](/docs/grid-angular-reactive-forms-integration--docs)** - Bind the grid to Angular FormArray for validation and dirty tracking
- **[API Reference](/docs/grid-angular-directives-grid--docs)** - Complete API documentation for all directives
- **[Grid Plugins](/docs/grid-plugins-selection-selection--docs)** - Explore all available plugins
