import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as FilteringStories from './filtering.stories';

<Meta of={FilteringStories} />

# Filtering Plugin

The Filtering plugin adds column header filters with text search, dropdown options, and custom filter panels. It supports both local filtering for small datasets and async handlers for server-side filtering on large datasets.

## Installation

```ts
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
```

## Basic Usage

<Tabs>
  <Tab label="Vanilla JS">

```ts
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';

const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'name', header: 'Name', filterable: true },
    { field: 'status', header: 'Status', filterable: true },
    { field: 'email', header: 'Email', filterable: true },
  ],
  plugins: [new FilteringPlugin({ debounceMs: 300 })],
};
grid.rows = data;
```

  </Tab>
  <Tab label="React">

```tsx
import '@toolbox-web/grid-react/features/filtering';
import { DataGrid } from '@toolbox-web/grid-react';

function MyGrid({ data }) {
  return (
    <DataGrid
      rows={data}
      columns={[
        { field: 'name', header: 'Name', filterable: true },
        { field: 'status', header: 'Status', filterable: true },
        { field: 'email', header: 'Email', filterable: true },
      ]}
      filtering={{ debounceMs: 300 }}
      style={{ height: '400px' }}
    />
  );
}
```

  </Tab>
  <Tab label="Vue">

```vue
<template>
  <tbw-grid ref="gridRef" style="height: 400px" />
</template>

<script setup>
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
import { ref, onMounted } from 'vue';

const gridRef = ref(null);
const props = defineProps(['data']);

onMounted(() => {
  gridRef.value.gridConfig = {
    columns: [
      { field: 'name', header: 'Name', filterable: true },
      { field: 'status', header: 'Status', filterable: true },
      { field: 'email', header: 'Email', filterable: true },
    ],
    plugins: [new FilteringPlugin({ debounceMs: 300 })],
  };
  gridRef.value.rows = props.data;
});
</script>
```

  </Tab>
  <Tab label="Angular">

```typescript
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
import { Grid } from '@toolbox-web/grid-angular';

@Component({
  selector: 'app-my-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="rows"
      [gridConfig]="config"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class MyGridComponent {
  rows = [...];

  config = {
    columns: [
      { field: 'name', header: 'Name', filterable: true },
      { field: 'status', header: 'Status', filterable: true },
      { field: 'email', header: 'Email', filterable: true },
    ],
    plugins: [new FilteringPlugin({ debounceMs: 300 })],
  };
}
```

  </Tab>
</Tabs>

## Demos

### Default Filtering

Type in column header filter inputs to filter rows. The plugin debounces input to avoid excessive re-filtering while typing.

<Canvas of={FilteringStories.Default} withToolbar />
<Controls of={FilteringStories.Default} />

### Custom Filter Panel

The `filterPanelRenderer` option lets you replace the default filter panel with custom UI.
When the renderer returns `undefined`, the default panel is used for that column.

<Canvas of={FilteringStories.CustomFilterPanel} withToolbar />

#### FilterPanelParams

Your custom renderer receives a `params` object with:

**Properties**

| Property         | Type           | Description                            |
| ---------------- | -------------- | -------------------------------------- |
| `field`          | `string`       | The field being filtered               |
| `column`         | `ColumnConfig` | Column configuration                   |
| `uniqueValues`   | `unknown[]`    | All unique values for this field       |
| `excludedValues` | `Set<unknown>` | Currently excluded values (set filter) |
| `searchText`     | `string`       | Current search text                    |

**Methods**

| Method            | Signature                                   | Description                               |
| ----------------- | ------------------------------------------- | ----------------------------------------- |
| `applySetFilter`  | `(excluded: unknown[]) => void`             | Apply a set filter (exclude these values) |
| `applyTextFilter` | `(op: FilterOperator, val: string) => void` | Apply a text filter with operator         |
| `clearFilter`     | `() => void`                                | Clear the filter for this field           |
| `closePanel`      | `() => void`                                | Close the filter panel                    |

#### Example: Radio-button Filter

```ts
const grid = document.querySelector('tbw-grid');

grid.gridConfig = {
  plugins: [
    new FilteringPlugin({
      filterPanelRenderer: (container, params) => {
        // Custom panel only for 'status' column
        if (params.field !== 'status') return undefined;

        container.innerHTML = `
          <div style="padding: 8px;">
            <label><input type="radio" name="status" value="all" checked> All</label>
            ${params.uniqueValues
              .map((v) => `<label><input type="radio" name="status" value="${v}"> ${v}</label>`)
              .join('')}
          </div>
        `;

        container.querySelectorAll('input').forEach((input) => {
          input.addEventListener('change', () => {
            if (input.value === 'all') {
              params.clearFilter();
            } else {
              // Exclude all except the selected value
              const excluded = params.uniqueValues.filter((v) => v !== input.value);
              params.applySetFilter(excluded);
            }
            params.closePanel();
          });
        });
      },
    }),
  ],
};
```

### Case-Sensitive Filtering

When `caseSensitive: true`, text filters distinguish between uppercase and lowercase letters. Try filtering the **Name** or **Department** columnâ€”typing "alice" won't match "Alice".

<Canvas of={FilteringStories.CaseSensitive} withToolbar />

### Async Filtering (Server-Side)

For large or server-side datasets, the default local filtering may not be suitable:

- **Not all unique values are available locally** for the filter panel
- **Filtering should happen on the backend** rather than in the browser

Use `valuesHandler` and `filterHandler` to customize this behavior:

```ts
grid.gridConfig = {
  columns: [...],
  plugins: [
    new FilteringPlugin({
      // Fetch unique values for a column from the server
      valuesHandler: async (field, column) => {
        const response = await fetch(`/api/distinct-values?field=${field}`);
        return response.json(); // Returns: ['Engineering', 'Marketing', ...]
      },

      // Apply filters on the server
      // FilterModel: { field, type, operator: 'notIn', value: excludedValues[] }
      filterHandler: async (filters, currentRows) => {
        const response = await fetch('/api/data', {
          method: 'POST',
          body: JSON.stringify({ filters }),
        });
        return response.json();
      },
    }),
  ],
};
```

**Handler signatures:**

| Handler         | Signature                                                    | Returns                  |
| --------------- | ------------------------------------------------------------ | ------------------------ |
| `valuesHandler` | `(field: string, column: ColumnConfig) => Promise<T[]>`      | Unique values for filter |
| `filterHandler` | `(filters: FilterModel[], rows: T[]) => T[] \| Promise<T[]>` | Filtered rows            |

When `valuesHandler` is provided, the filter panel shows a loading indicator while fetching values.
When `filterHandler` is provided, filter application bypasses the local `processRows` hook.

<Canvas of={FilteringStories.AsyncFiltering} withToolbar />

## Configuration Options

| Option                | Type                  | Default | Description                                 |
| --------------------- | --------------------- | ------- | ------------------------------------------- |
| `debounceMs`          | `number`              | `300`   | Debounce delay for filter input             |
| `caseSensitive`       | `boolean`             | `false` | Case-sensitive string matching              |
| `trimInput`           | `boolean`             | `true`  | Trim whitespace from filter input           |
| `useWorker`           | `boolean`             | `true`  | Use Web Worker for datasets >1000 rows      |
| `filterPanelRenderer` | `FilterPanelRenderer` | -       | Custom filter panel renderer                |
| `valuesHandler`       | `FilterValuesHandler` | -       | Async handler to fetch unique filter values |
| `filterHandler`       | `FilterHandler<TRow>` | -       | Async handler to apply filters remotely     |

## Column Configuration

```ts
const columns = [
  {
    field: 'name',
    filterable: true, // Enable filtering
    filterType: 'text', // 'text' | 'select' | 'number' | 'date'
  },
  {
    field: 'status',
    filterable: true,
    filterType: 'select',
    filterOptions: ['Active', 'Inactive', 'Pending'],
  },
];
```

## Programmatic API

```ts
const plugin = grid.getPlugin(FilteringPlugin);

// Set filter value
plugin.setFilter('name', 'Alice');

// Get current filters
const filters = plugin.getFilters();

// Clear all filters
plugin.clearFilters();

// Clear specific filter
plugin.clearFilter('name');
```

## Events

The FilteringPlugin emits events when filter state changes. Open filter panels and
apply filters to see the events:

<Canvas of={FilteringStories.FilterEvents} withToolbar />

| Event | Description |
| ----- | ----------- |
| `filter-change` | Fired when filters are applied, changed, or cleared |

### `filter-change` Detail

```ts
interface FilterChangeDetail {
  filters: FilterModel[];  // Active filter configurations
}
```

## Styling

The filter panel and inputs support CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-filter-panel-bg` | `var(--tbw-color-panel-bg)` | Panel background |
| `--tbw-filter-panel-fg` | `var(--tbw-color-fg)` | Panel text color |
| `--tbw-filter-panel-border` | `var(--tbw-color-border)` | Panel border |
| `--tbw-filter-panel-radius` | `var(--tbw-border-radius)` | Panel border radius |
| `--tbw-filter-panel-shadow` | `var(--tbw-color-shadow)` | Panel shadow |
| `--tbw-filter-input-bg` | `var(--tbw-color-bg)` | Input background |
| `--tbw-filter-input-border` | `var(--tbw-color-border)` | Input border |
| `--tbw-filter-input-focus` | `var(--tbw-color-accent)` | Input focus border |
| `--tbw-filter-active-color` | `var(--tbw-color-accent)` | Active filter indicator |
| `--tbw-filter-btn-padding` | `var(--tbw-button-padding)` | Filter button padding |
| `--tbw-filter-btn-font-weight` | `500` | Filter button font weight |
| `--tbw-filter-btn-min-height` | `auto` | Filter button min height |
| `--tbw-filter-search-padding` | `var(--tbw-spacing-sm) var(--tbw-spacing-md)` | Search input padding |
| `--tbw-filter-item-height` | `28px` | Filter value item height (for virtualization) |
| `--tbw-filter-btn-display` | `inline-flex` | Filter button display (set to `none` to hide) |
| `--tbw-filter-btn-visibility` | `visible` | Filter button visibility |
| `--tbw-panel-padding` | `0.75em` | Panel padding |
| `--tbw-panel-gap` | `0.5em` | Gap between elements |
| `--tbw-animation-duration` | `200ms` | Panel open/close animation |

### Theming Filter Panels

The filter panel is rendered in `document.body` for proper z-index stacking. To apply theme CSS variables:

1. **Add a theme class to the grid** (e.g., `tbw-grid.eds-theme`)
2. **The class is automatically copied** to the filter panel

```css
/* Define theme on a CSS class */
.eds-theme {
  --tbw-filter-panel-bg: #f5f5f5;
  --tbw-filter-btn-padding: 8px 16px;
  --tbw-filter-btn-font-weight: 500;
  --tbw-filter-btn-min-height: 48px;
  --tbw-filter-item-height: 48px;
}
```

```html
<!-- Apply class to grid - it cascades to filter panel -->
<tbw-grid class="eds-theme" ...></tbw-grid>
```

### Hiding Filter Buttons Until Hover

To show filter buttons only when hovering over a column header:

```css
tbw-grid {
  --tbw-filter-btn-visibility: hidden;
}

tbw-grid .header-row .cell:hover .tbw-filter-btn,
tbw-grid .header-row .cell .tbw-filter-btn.active {
  visibility: visible;
}
```

### Example

```css
tbw-grid {
  /* Custom filter panel styling */
  --tbw-filter-panel-bg: #1e1e1e;
  --tbw-filter-panel-fg: #ffffff;
  --tbw-filter-panel-border: #444444;
  --tbw-filter-input-bg: #2d2d2d;
  --tbw-filter-input-border: #555555;
  --tbw-filter-active-color: #4fc3f7;
}
```

### CSS Classes

The filter panel uses these class names for advanced customization:

| Class | Element |
| --- | --- |
| `.tbw-filter-panel` | Dropdown panel container |
| `.tbw-filter-search` | Text search input |
| `.tbw-filter-list` | Options list container |
| `.tbw-filter-option` | Individual filter option |
| `.tbw-filter-option.selected` | Selected option |
| `.tbw-filter-buttons` | Action button group |
| `.tbw-filter-clear` | Clear filter button |
| `.tbw-filter-apply` | Apply filter button |
