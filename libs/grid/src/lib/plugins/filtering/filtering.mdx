import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as FilteringStories from './filtering.stories';

<Meta of={FilteringStories} />

# Filtering Plugin

The Filtering plugin adds column header filters with text search, dropdown options, and custom filter panels. It supports both local filtering for small datasets and async handlers for server-side filtering on large datasets.

## Installation

```ts
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
```

## Basic Usage

<Tabs>
  <Tab label="Vanilla JS">

```ts
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';

const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'name', header: 'Name', filterable: true },
    { field: 'status', header: 'Status', filterable: true },
    { field: 'email', header: 'Email', filterable: true },
  ],
  plugins: [new FilteringPlugin({ debounceMs: 300 })],
};
grid.rows = data;
```

  </Tab>
  <Tab label="React">

```tsx
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
import { useEffect, useRef } from 'react';
import type { DataGridElement } from '@toolbox-web/grid';

function MyGrid({ data }) {
  const gridRef = useRef<DataGridElement>(null);

  useEffect(() => {
    if (gridRef.current) {
      gridRef.current.gridConfig = {
        columns: [
          { field: 'name', header: 'Name', filterable: true },
          { field: 'status', header: 'Status', filterable: true },
          { field: 'email', header: 'Email', filterable: true },
        ],
        plugins: [new FilteringPlugin({ debounceMs: 300 })],
      };
      gridRef.current.rows = data;
    }
  }, [data]);

  return <tbw-grid ref={gridRef} style={{ height: '400px' }} />;
}
```

  </Tab>
  <Tab label="Vue">

```vue
<template>
  <tbw-grid ref="gridRef" style="height: 400px" />
</template>

<script setup>
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
import { ref, onMounted } from 'vue';

const gridRef = ref(null);
const props = defineProps(['data']);

onMounted(() => {
  gridRef.value.gridConfig = {
    columns: [
      { field: 'name', header: 'Name', filterable: true },
      { field: 'status', header: 'Status', filterable: true },
      { field: 'email', header: 'Email', filterable: true },
    ],
    plugins: [new FilteringPlugin({ debounceMs: 300 })],
  };
  gridRef.value.rows = props.data;
});
</script>
```

  </Tab>
  <Tab label="Angular">

```typescript
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import '@toolbox-web/grid';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
import { Grid } from '@toolbox-web/grid-angular';

@Component({
  selector: 'app-my-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="rows"
      [gridConfig]="config"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class MyGridComponent {
  rows = [...];

  config = {
    columns: [
      { field: 'name', header: 'Name', filterable: true },
      { field: 'status', header: 'Status', filterable: true },
      { field: 'email', header: 'Email', filterable: true },
    ],
    plugins: [new FilteringPlugin({ debounceMs: 300 })],
  };
}
```

  </Tab>
</Tabs>

## Demos

### Default Filtering

Type in column header filter inputs to filter rows. The plugin debounces input to avoid excessive re-filtering while typing.

<Canvas of={FilteringStories.Default} withToolbar />
<Controls of={FilteringStories.Default} />

### Custom Filter Panel

The `filterPanelRenderer` option lets you replace the default filter panel with custom UI.
When the renderer returns `undefined`, the default panel is used for that column.

<Canvas of={FilteringStories.CustomFilterPanel} withToolbar />

#### FilterPanelParams

Your custom renderer receives a `params` object with:

**Properties**

| Property         | Type           | Description                            |
| ---------------- | -------------- | -------------------------------------- |
| `field`          | `string`       | The field being filtered               |
| `column`         | `ColumnConfig` | Column configuration                   |
| `uniqueValues`   | `unknown[]`    | All unique values for this field       |
| `excludedValues` | `Set<unknown>` | Currently excluded values (set filter) |
| `searchText`     | `string`       | Current search text                    |

**Methods**

| Method            | Signature                                   | Description                               |
| ----------------- | ------------------------------------------- | ----------------------------------------- |
| `applySetFilter`  | `(excluded: unknown[]) => void`             | Apply a set filter (exclude these values) |
| `applyTextFilter` | `(op: FilterOperator, val: string) => void` | Apply a text filter with operator         |
| `clearFilter`     | `() => void`                                | Clear the filter for this field           |
| `closePanel`      | `() => void`                                | Close the filter panel                    |

#### Example: Radio-button Filter

```ts
const grid = document.querySelector('tbw-grid');

grid.gridConfig = {
  plugins: [
    new FilteringPlugin({
      filterPanelRenderer: (container, params) => {
        // Custom panel only for 'status' column
        if (params.field !== 'status') return undefined;

        container.innerHTML = `
          <div style="padding: 8px;">
            <label><input type="radio" name="status" value="all" checked> All</label>
            ${params.uniqueValues
              .map((v) => `<label><input type="radio" name="status" value="${v}"> ${v}</label>`)
              .join('')}
          </div>
        `;

        container.querySelectorAll('input').forEach((input) => {
          input.addEventListener('change', () => {
            if (input.value === 'all') {
              params.clearFilter();
            } else {
              // Exclude all except the selected value
              const excluded = params.uniqueValues.filter((v) => v !== input.value);
              params.applySetFilter(excluded);
            }
            params.closePanel();
          });
        });
      },
    }),
  ],
};
```

### Case-Sensitive Filtering

When `caseSensitive: true`, text filters distinguish between uppercase and lowercase letters. Try filtering the **Name** or **Department** columnâ€”typing "alice" won't match "Alice".

<Canvas of={FilteringStories.CaseSensitive} withToolbar />

### Async Filtering (Server-Side)

For large or server-side datasets, the default local filtering may not be suitable:

- **Not all unique values are available locally** for the filter panel
- **Filtering should happen on the backend** rather than in the browser

Use `valuesHandler` and `filterHandler` to customize this behavior:

```ts
grid.gridConfig = {
  columns: [...],
  plugins: [
    new FilteringPlugin({
      // Fetch unique values for a column from the server
      valuesHandler: async (field, column) => {
        const response = await fetch(`/api/distinct-values?field=${field}`);
        return response.json(); // Returns: ['Engineering', 'Marketing', ...]
      },

      // Apply filters on the server
      // FilterModel: { field, type, operator: 'notIn', value: excludedValues[] }
      filterHandler: async (filters, currentRows) => {
        const response = await fetch('/api/data', {
          method: 'POST',
          body: JSON.stringify({ filters }),
        });
        return response.json();
      },
    }),
  ],
};
```

**Handler signatures:**

| Handler         | Signature                                                    | Returns                  |
| --------------- | ------------------------------------------------------------ | ------------------------ |
| `valuesHandler` | `(field: string, column: ColumnConfig) => Promise<T[]>`      | Unique values for filter |
| `filterHandler` | `(filters: FilterModel[], rows: T[]) => T[] \| Promise<T[]>` | Filtered rows            |

When `valuesHandler` is provided, the filter panel shows a loading indicator while fetching values.
When `filterHandler` is provided, filter application bypasses the local `processRows` hook.

<Canvas of={FilteringStories.AsyncFiltering} withToolbar />

## Configuration Options

| Option                | Type                  | Default | Description                                 |
| --------------------- | --------------------- | ------- | ------------------------------------------- |
| `debounceMs`          | `number`              | `300`   | Debounce delay for filter input             |
| `caseSensitive`       | `boolean`             | `false` | Case-sensitive string matching              |
| `trimInput`           | `boolean`             | `true`  | Trim whitespace from filter input           |
| `useWorker`           | `boolean`             | `true`  | Use Web Worker for datasets >1000 rows      |
| `filterPanelRenderer` | `FilterPanelRenderer` | -       | Custom filter panel renderer                |
| `valuesHandler`       | `FilterValuesHandler` | -       | Async handler to fetch unique filter values |
| `filterHandler`       | `FilterHandler<TRow>` | -       | Async handler to apply filters remotely     |

## Column Configuration

```ts
const columns = [
  {
    field: 'name',
    filterable: true, // Enable filtering
    filterType: 'text', // 'text' | 'select' | 'number' | 'date'
  },
  {
    field: 'status',
    filterable: true,
    filterType: 'select',
    filterOptions: ['Active', 'Inactive', 'Pending'],
  },
];
```

## Programmatic API

```ts
const plugin = grid.getPlugin(FilteringPlugin);

// Set filter value
plugin.setFilter('name', 'Alice');

// Get current filters
const filters = plugin.getFilters();

// Clear all filters
plugin.clearFilters();

// Clear specific filter
plugin.clearFilter('name');
```

## Styling

```css
/* Filter input */
tbw-grid::part(filter-input) {
  border: 1px solid var(--tbw-border-color);
  border-radius: 4px;
  padding: 4px 8px;
}

/* Filter input focused */
tbw-grid::part(filter-input):focus {
  border-color: var(--tbw-primary-color);
  outline: none;
}

/* Filter row */
tbw-grid::part(filter-row) {
  background: var(--tbw-filter-row-bg, #fafafa);
}
```
