import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as MultiSortStories from './multi-sort.stories';

<Meta of={MultiSortStories} />

# Multi-Sort Plugin

The Multi-Sort plugin enables sorting by multiple columns at once—hold Shift and click additional column headers to build up a sort stack. Priority badges show the sort order, so users always know which column takes precedence.

## Installation

```ts
import { MultiSortPlugin } from '@toolbox-web/grid/plugins/multi-sort';
```

## Basic Usage

Mark columns as `sortable: true` and add the plugin. Users Shift+click to add columns to the sort stack, and regular click to reset to single-column sort.

<Tabs>
  <Tab label="Vanilla JS">
```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'name', header: 'Name', sortable: true },
    { field: 'department', header: 'Department', sortable: true },
    { field: 'salary', header: 'Salary', type: 'number', sortable: true },
    { field: 'startDate', header: 'Start Date', type: 'date', sortable: true },
  ],
  plugins: [
    new MultiSortPlugin({
      maxSortColumns: 3,
      showSortIndex: true,
    }),
  ],
};

// Listen for sort changes
grid.addEventListener('sort-change', (e) => {
  console.log('Active sorts:', e.detail.sortModel);
});
```
  </Tab>
  <Tab label="React">
```tsx
import '@toolbox-web/grid-react/features/sorting';
import { DataGrid } from '@toolbox-web/grid-react';

function SortableGrid({ data }) {
  return (
    <DataGrid
      rows={data}
      columns={[
        { field: 'name', header: 'Name', sortable: true },
        { field: 'department', header: 'Department', sortable: true },
        { field: 'salary', header: 'Salary', type: 'number', sortable: true },
      ]}
      sorting={{ multi: true, maxSortLevels: 3 }}
      onSortChange={(e) => console.log('Sort changed:', e.detail.sortModel)}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```html
<script setup>
import '@toolbox-web/grid-vue/features/multi-sort';
import { TbwGrid, TbwGridColumn } from '@toolbox-web/grid-vue';

const data = [
  { name: 'Alice', department: 'Engineering', salary: 95000 },
  { name: 'Bob', department: 'Marketing', salary: 75000 },
];

const onSortChange = (e) => {
  console.log('Sort changed:', e.detail.sortModel);
};
</script>

<template>
  <TbwGrid
    :rows="data"
    :multi-sort="{ maxSortColumns: 3 }"
    @sort-change="onSortChange"
  >
    <TbwGridColumn field="name" header="Name" sortable />
    <TbwGridColumn field="department" header="Department" sortable />
    <TbwGridColumn field="salary" header="Salary" type="number" sortable />
  </TbwGrid>
</template>
```
  </Tab>
  <Tab label="Angular">
```typescript
// Feature import - enables the [sorting] input
import '@toolbox-web/grid-angular/features/sorting';

import { Component } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-sortable-grid',
  imports: [Grid],
  template: `
    <tbw-grid
      [rows]="rows"
      [columns]="columns"
      [sorting]="{ maxSortColumns: 3 }"
      (sort-change)="onSortChange($event)"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class SortableGridComponent {
  rows = [
    { name: 'Alice', department: 'Engineering', salary: 95000 },
    { name: 'Bob', department: 'Marketing', salary: 75000 },
  ];

  columns: ColumnConfig[] = [
    { field: 'name', header: 'Name', sortable: true },
    { field: 'department', header: 'Department', sortable: true },
    { field: 'salary', header: 'Salary', type: 'number', sortable: true },
  ];

  onSortChange(e: CustomEvent) {
    console.log('Sort changed:', e.detail.sortModel);
  }
}
```
  </Tab>
</Tabs>

## Demos

### Default Multi-Sort

Hold Shift and click multiple column headers to sort by multiple columns.

<Canvas of={MultiSortStories.Default} withToolbar />
<Controls of={MultiSortStories.Default} />

### With Initial Sort

Pre-configured sort order on load.

<Canvas of={MultiSortStories.WithInitialSort} withToolbar />

### Without Badges

Hide the sort priority numbers.

<Canvas of={MultiSortStories.NoBadges} withToolbar />

## Configuration Options

| Option           | Type      | Default | Description                |     |
| ---------------- | --------- | ------- | -------------------------- | --- |
| `maxSortColumns` | `number`  | `3`     | Maximum columns to sort by |
| `showSortIndex`  | `boolean` | `true`  | Show sort priority badges  |

## Initial Sort Configuration

```ts
new MultiSortPlugin({
  initialSort: [
    { field: 'department', direction: 'asc' },
    { field: 'salary', direction: 'desc' },
  ],
});
```

## Events

| Event         | Detail                       | Description             |
| ------------- | ---------------------------- | ----------------------- |
| `sort-change` | `{ sortModel: SortModel[] }` | Fired when sort changes |

```ts
grid.addEventListener('sort-change', (e) => {
  console.log('Sort model:', e.detail.sortModel);
  // [{ field: 'name', direction: 'asc' }, { field: 'salary', direction: 'desc' }]
});
```

## Programmatic API

```ts
const plugin = grid.getPlugin(MultiSortPlugin);

// Set sort programmatically
plugin.setSortModel([
  { field: 'department', direction: 'asc' },
  { field: 'name', direction: 'asc' },
]);

// Get current sort model
const sortModel = plugin.getSortModel();

// Clear all sorting
plugin.clearSort();

// Check sort state for a specific column
const direction = plugin.getSortDirection('salary'); // 'asc' | 'desc' | undefined
const index = plugin.getSortIndex('salary'); // number | undefined
```

## Keyboard Shortcuts

| Shortcut        | Action                              |
| --------------- | ----------------------------------- |
| `Click header`  | Sort by column (clears other sorts) |
| `Shift + Click` | Add column to multi-sort            |
| `Ctrl + Click`  | Toggle sort direction               |

## Styling

The grid uses Light DOM, so standard CSS selectors work for styling sort indicators:

```css
/* Sort indicator icon */
tbw-grid .sort-indicator {
  margin-left: 4px;
}

/* Sort priority badge */
tbw-grid .sort-badge {
  background: var(--tbw-color-accent);
  color: var(--tbw-color-accent-fg);
  border-radius: 50%;
  font-size: 10px;
  padding: 2px 6px;
  margin-left: 4px;
}
```

## Row Insertion with Active Sort

When multi-sort is active, assigning `rows` automatically re-sorts the data — so a
newly inserted row will jump to its sorted position. If you want the row to stay
exactly where you placed it (e.g., after a user clicks "Add Row"), use `insertRow()`:

```ts
grid.insertRow(3, newRow); // stays at visible index 3, auto-animates
```

The row is also added to source data, so the next full `grid.rows = freshData`
assignment re-sorts normally. See the
[API Reference → Insert & Remove Rows](?path=/docs/grid-api--docs#insert--remove-rows)
for full details.

> **Tip:** Do **not** use `insertRow()` for data refreshes (API responses,
> WebSocket updates). In those cases just set `grid.rows = newData` and let
> multi-sort re-apply.

## See Also
