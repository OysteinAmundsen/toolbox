import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import * as ServerSideStories from './server-side.stories';

<Meta of={ServerSideStories} />

# Server-Side Plugin

The Server-Side plugin enables lazy loading of data from a remote server.

## Installation

```ts
import { ServerSidePlugin } from '@toolbox-web/grid/plugins/server-side';
```

## Basic Usage

```ts
const dataSource = {
  async getRows(params) {
    const response = await fetch(`/api/data?start=${params.startRow}&end=${params.endRow}`);
    const data = await response.json();
    return { rows: data.rows, totalRowCount: data.total };
  },
};

const plugin = new ServerSidePlugin({ pageSize: 50 });

grid.gridConfig = {
  columns: [...],
  plugins: [plugin],
};

grid.ready().then(() => plugin.setDataSource(dataSource));
```

## Demos

### Virtual Scroll Mode

<Canvas of={ServerSideStories.Default} withToolbar />
<Controls of={ServerSideStories.Default} />

### Paging Mode

<Canvas of={ServerSideStories.PagingMode} withToolbar />

### Server-Side Sorting

Use the `sortHandler` config option for async sorting. When a user clicks a sortable column header,
your handler is called instead of the built-in sorting logic. This is ideal for large datasets
where sorting should happen on the backend.

<Canvas of={ServerSideStories.ServerSideSorting} withToolbar />

```ts
grid.gridConfig = {
  columns: [...],
  sortHandler: async (rows, sortState, columns) => {
    // sortState: { field: 'name', direction: 1 } // 1 = asc, -1 = desc
    const response = await fetch(
      `/api/data?sort=${sortState.field}&dir=${sortState.direction === 1 ? 'asc' : 'desc'}`
    );
    return response.json();
  },
};
```

The handler receives:

- `rows` - Current row array (may be useful for optimistic updates)
- `sortState` - `{ field: string, direction: 1 | -1 }`
- `columns` - Column configurations (access `sortComparator` if needed)

Return the sorted array directly or a Promise that resolves to it.

### Server-Side Filtering

For server-side filtering, use the FilteringPlugin's async handlers.
See the [Filtering Plugin documentation](?path=/docs/grid-plugins-filtering--docs#async-handlers-for-server-side-filtering) for details on `valuesHandler` and `filterHandler`.

## Configuration Options

| Option                  | Type     | Default    | Description                |
| ----------------------- | -------- | ---------- | -------------------------- |
| `pageSize`              | `number` | `100`      | Rows per block             |
| `cacheBlockSize`        | `number` | `pageSize` | Cache block size           |
| `maxConcurrentRequests` | `number` | `2`        | Max parallel data requests |

## Data Source Interface

```ts
interface ServerSideDataSource {
  getRows(params: GetRowsParams): Promise<GetRowsResult>;
}

interface GetRowsParams {
  startRow: number;
  endRow: number;
  sortModel?: { field: string; direction: 'asc' | 'desc' }[];
  filterModel?: Record<string, FilterCondition>;
}

interface GetRowsResult {
  rows: any[];
  totalRowCount: number;
}
```

## Programmatic API

```ts
const plugin = grid.getPlugin(ServerSidePlugin);

plugin.setDataSource(newDataSource);
plugin.refresh();
plugin.clearCache();
```
