{/* Plugins.mdx */}
import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Grid/Plugins/Overview" />

# Grid Plugins

The `@toolbox-web/grid` plugin architecture allows you to extend the grid with powerful features while keeping the core bundle lightweight. Plugins are tree-shakeable—only import what you need.

## Available Plugins

### Editing & Data Entry

| Plugin                                                       | Description                                               |
| ------------------------------------------------------------ | --------------------------------------------------------- |
| [Editing](../?path=/docs/grid-plugins-editing--docs)         | Inline cell editing with built-in editors                 |
| [Undo/Redo](../?path=/docs/grid-plugins-undo-redo--docs)     | Undo/redo for cell edits with history stack               |

> **Note:** Editing is opt-in. To enable `editable` and `editor` column properties, you must register the `EditingPlugin`. This keeps the core bundle lightweight and provides runtime validation to catch misconfigurations early.

### Selection & Interaction

| Plugin                                                         | Description                                          |
| -------------------------------------------------------------- | ---------------------------------------------------- |
| [Selection](../?path=/docs/grid-plugins-selection--docs)       | Cell, row, and range selection with keyboard support |
| [Clipboard](../?path=/docs/grid-plugins-clipboard--docs)       | Copy/paste with Ctrl+C/V                             |
| [Context Menu](../?path=/docs/grid-plugins-context-menu--docs) | Right-click context menus with submenus              |
| [Reorder](../?path=/docs/grid-plugins-reorder--docs)           | Drag-and-drop column reordering                      |

### Filtering & Sorting

| Plugin                                                     | Description                                       |
| ---------------------------------------------------------- | ------------------------------------------------- |
| [Filtering](../?path=/docs/grid-plugins-filtering--docs)   | Column header filters with search and dropdown    |
| [Multi-Sort](../?path=/docs/grid-plugins-multi-sort--docs) | Sort by multiple columns with priority indicators |

### Grouping & Hierarchy

| Plugin                                                                | Description                                     |
| --------------------------------------------------------------------- | ----------------------------------------------- |
| [Row Grouping](../?path=/docs/grid-plugins-grouping-rows--docs)       | Group rows by field values with expand/collapse |
| [Column Grouping](../?path=/docs/grid-plugins-grouping-columns--docs) | Visual column grouping with nested headers      |
| [Tree](../?path=/docs/grid-plugins-tree--docs)                        | Hierarchical tree data display                  |
| [Master-Detail](../?path=/docs/grid-plugins-master-detail--docs)      | Expandable detail rows                          |
| [Pivot](../?path=/docs/grid-plugins-pivot--docs)                      | Pivot table transformation with aggregations    |

### Layout & Display

| Plugin                                                                           | Description                                    |
| -------------------------------------------------------------------------------- | ---------------------------------------------- |
| [Pinned Columns](../?path=/docs/grid-plugins-pinned-columns--docs)               | Pin columns to left or right edge              |
| [Pinned Rows](../?path=/docs/grid-plugins-pinned-rows--docs)                     | Status bar with aggregations and custom panels |
| [Visibility](../?path=/docs/grid-plugins-visibility--docs)                       | Show/hide columns dynamically                  |
| [Column Virtualization](../?path=/docs/grid-plugins-column-virtualization--docs) | Performance optimization for many columns      |

### Data & Export

| Plugin                                                       | Description                           |
| ------------------------------------------------------------ | ------------------------------------- |
| [Export](../?path=/docs/grid-plugins-export--docs)           | Export to CSV, JSON formats           |
| [Server-Side](../?path=/docs/grid-plugins-server-side--docs) | Lazy loading from remote data sources |

## Plugin Dependencies

Some plugins depend on other plugins to function. Dependencies can be **hard** (required) or **soft** (optional enhancement).

### Dependency Types

| Type | Behavior | Example |
| ---- | -------- | ------- |
| **Hard (Required)** | Plugin will throw an error if the dependency is missing | UndoRedoPlugin → EditingPlugin |
| **Soft (Optional)** | Plugin works without it, but gains extra features when present | VisibilityPlugin → ReorderPlugin |

### Current Plugin Dependencies

| Plugin | Depends On | Type | Reason |
| ------ | ---------- | ---- | ------ |
| **UndoRedoPlugin** | EditingPlugin | Hard | Tracks cell edit history for undo/redo |
| **ClipboardPlugin** | SelectionPlugin | Hard | Needs selection to determine what cells to copy |
| **VisibilityPlugin** | ReorderPlugin | Soft | Enables drag-to-reorder columns in visibility panel |

### Plugin Load Order

Dependencies must be loaded **before** the dependent plugin:

```typescript
// ✅ Correct - EditingPlugin loaded before UndoRedoPlugin
plugins: [
  new EditingPlugin(),
  new UndoRedoPlugin(),
]

// ❌ Wrong - throws error at runtime
plugins: [
  new UndoRedoPlugin(), // Error: EditingPlugin required
  new EditingPlugin(),
]
```

### Declaring Dependencies in Custom Plugins

Custom plugins can declare their own dependencies using the static `dependencies` property:

```typescript
import { BaseGridPlugin, type PluginDependency } from '@toolbox-web/grid';

class MyPlugin extends BaseGridPlugin<MyConfig> {
  // Declare dependencies
  static override readonly dependencies: PluginDependency[] = [
    { name: 'selection', required: true, reason: 'MyPlugin needs selection state' },
    { name: 'filtering', required: false, reason: 'Enables filtered export' },
  ];

  readonly name = 'myPlugin';
  // ...
}
```

The grid validates dependencies at attachment time and provides helpful error messages:

```
[tbw-grid] Plugin dependency error: MyPlugin needs selection state.
  → Add the plugin to your gridConfig.plugins array:
    import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';
    plugins: [new SelectionPlugin(), new MyPlugin(), ...]
```

## Using Plugins

### Import Paths

The grid package provides multiple entry points for different use cases:

| Entry Point | What It Includes | Tree-Shaking |
| ----------- | ---------------- | ------------ |
| `@toolbox-web/grid` | Core grid only (auto-registers `<tbw-grid>`) | N/A |
| `@toolbox-web/grid/all` | Core + **all** plugins bundled | ❌ No* |
| `@toolbox-web/grid/plugins/*` | Individual plugin (e.g., `/plugins/selection`) | ✅ Yes |

> **Important:** Do not import from both `@toolbox-web/grid` and `@toolbox-web/grid/all` in the same application. The `all` entry point already includes the core grid, so importing both will register the custom element twice.

#### Recommended Patterns

**For production apps (best tree-shaking):**
```typescript
// Import core grid
import '@toolbox-web/grid';

// Import only the plugins you need
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
import { EditingPlugin } from '@toolbox-web/grid/plugins/editing';
```

**For prototyping or when bundle size is not critical:**
```typescript
// Import everything at once (includes core grid + all plugins)
import { SelectionPlugin, FilteringPlugin, EditingPlugin } from '@toolbox-web/grid/all';
```

*\*Tree-shaking note: When importing from `/all`, all plugins are included in your bundle regardless of which ones you use. Modern bundlers cannot tree-shake unused exports from `/all` because they're all re-exported from a single file. For optimal bundle size, import plugins individually.*

### Installation

Plugins are included in the main package. Import only what you need:

```typescript
import '@toolbox-web/grid';
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';
import { FilteringPlugin } from '@toolbox-web/grid/plugins/filtering';
```

### Registration

Pass plugin instances to the `gridConfig.plugins` array:

```typescript
const grid = document.querySelector('tbw-grid');

grid.gridConfig = {
  columns: [...],
  plugins: [
    new SelectionPlugin({ mode: 'row' }),
    new FilteringPlugin({ debounceMs: 300 }),
  ],
};
```

### Accessing Plugin Instances

Use `grid.getPlugin()` to access a registered plugin:

```typescript
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';

const selection = grid.getPlugin(SelectionPlugin);
if (selection) {
  // Call plugin methods
  selection.selectAll();
  selection.clearSelection();

  // Get current selection
  const ranges = selection.getSelectedRanges();
}
```

## Plugin Configuration

Each plugin accepts a configuration object:

```typescript
// Selection plugin options
new SelectionPlugin({
  mode: 'row', // 'cell' | 'row' | 'range'
  multiSelect: true, // Allow selecting multiple items
  checkboxColumn: true, // Add checkbox column for row selection
});

// Filtering plugin options
new FilteringPlugin({
  debounceMs: 200, // Debounce filter input
  caseSensitive: false, // Case-insensitive filtering
});

// Export plugin options
new ExportPlugin({
  formats: ['csv', 'json'],
  filename: 'grid-export',
});
```

## Creating Custom Plugins

Plugins extend `BaseGridPlugin` and implement lifecycle hooks:

```typescript
import { BaseGridPlugin } from '@toolbox-web/grid/plugins';

interface MyPluginConfig {
  option1: string;
  option2: boolean;
}

class MyPlugin extends BaseGridPlugin<MyPluginConfig> {
  readonly name = 'myPlugin';
  readonly version = '1.0.0';

  // CSS styles (loaded from external file in real plugins)
  override readonly styles = `
    .my-plugin-class { color: blue; }
  `;

  // Called when plugin is attached to grid
  attach(grid) {
    super.attach(grid);
    // Setup: add event listeners, initialize state
  }

  // Called when plugin is detached
  detach() {
    // Cleanup: remove listeners, clear state
    super.detach();
  }

  // Transform column definitions
  processColumns(columns) {
    return columns.map((col) => ({
      ...col,
      // Add custom column processing
    }));
  }

  // Transform row data
  processRows(rows) {
    return rows; // Filter, sort, group, etc.
  }

  // Called after grid renders
  afterRender() {
    // DOM manipulation, measurements, etc.
  }

  // Handle keyboard events
  onKeyDown(event) {
    if (event.key === 'MyHotkey') {
      // Handle and return true to prevent default
      return true;
    }
    return false;
  }
}
```

## Plugin Lifecycle

1. **Construction**: `new MyPlugin(config)` - Store configuration
2. **Attach**: `attach(grid)` - Grid reference provided, setup listeners
3. **Process**: `processColumns()` / `processRows()` - Transform data
4. **Render**: `afterRender()` - Post-render DOM work
5. **Detach**: `detach()` - Cleanup when removed or grid destroyed

Plugins receive a `disconnectSignal` (AbortSignal) for automatic cleanup of event listeners when the plugin is detached.
