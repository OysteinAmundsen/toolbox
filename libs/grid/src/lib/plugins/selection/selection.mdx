import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as SelectionStories from './selection.stories';

<Meta of={SelectionStories} />

# Selection Plugin

The Selection plugin adds cell, row, and range selection capabilities to the grid with full keyboard support. Whether you need simple cell highlighting or complex multi-range selections, this plugin has you covered.

## Installation

```ts
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';
```

## Basic Usage

<Tabs>
  <Tab label="Vanilla JS">

```ts
import '@toolbox-web/grid';
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';

const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'id', header: 'ID' },
    { field: 'name', header: 'Name' },
    { field: 'email', header: 'Email' },
  ],
  plugins: [
    new SelectionPlugin({ mode: 'row' }),
  ],
};
grid.rows = data;
```

  </Tab>
  <Tab label="React">

```tsx
import '@toolbox-web/grid-react/features/selection';
import { DataGrid } from '@toolbox-web/grid-react';

function MyGrid({ data }) {
  return (
    <DataGrid
      rows={data}
      columns={[
        { field: 'id', header: 'ID' },
        { field: 'name', header: 'Name' },
        { field: 'email', header: 'Email' },
      ]}
      selection={{ mode: 'row' }}
      style={{ height: '400px' }}
    />
  );
}
```

  </Tab>
  <Tab label="Vue">

```html
<script setup>
import '@toolbox-web/grid-vue/features/selection';
import { TbwGrid, TbwGridColumn } from '@toolbox-web/grid-vue';

const data = [
  { id: 1, name: 'Alice', email: 'alice@example.com' },
  { id: 2, name: 'Bob', email: 'bob@example.com' },
];
</script>

<template>
  <TbwGrid :rows="data" selection="row" style="height: 400px">
    <TbwGridColumn field="id" header="ID" />
    <TbwGridColumn field="name" header="Name" />
    <TbwGridColumn field="email" header="Email" />
  </TbwGrid>
</template>
```

  </Tab>
  <Tab label="Angular">

```typescript
// Feature import - enables the [selection] input
import '@toolbox-web/grid-angular/features/selection';

import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-my-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="rows"
      [columns]="columns"
      [selection]="'row'"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class MyGridComponent {
  rows = [
    { id: 1, name: 'Alice', email: 'alice@example.com' },
    { id: 2, name: 'Bob', email: 'bob@example.com' },
  ];

  columns: ColumnConfig[] = [
    { field: 'id', header: 'ID' },
    { field: 'name', header: 'Name' },
    { field: 'email', header: 'Email' },
  ];
}
```

  </Tab>
</Tabs>

## Demos

### Default (Cell Mode)

Click cells to select them individually. Great for spreadsheet-style interactions.

<Canvas of={SelectionStories.Default} withToolbar />
<Controls of={SelectionStories.Default} />

### Row Selection Mode

Click anywhere in a row to select the entire row. Perfect for data grids where you're working with complete records.

<Canvas of={SelectionStories.RowMode} withToolbar />

### Range Selection Mode

Click and drag or Shift+Click to select rectangular ranges. Ideal for data export or bulk operations.

<Canvas of={SelectionStories.RangeMode} withToolbar />

## Configuration Options

### Grid-Level Toggle

You can disable selection grid-wide using `gridConfig.selectable`:

```ts
grid.gridConfig = {
  selectable: false, // Disables ALL selection
  plugins: [new SelectionPlugin({ mode: 'range' })],
};
```

This is useful for toggling selection on/off at runtime without removing the plugin.

### Plugin Options

| Option | Type                         | Default  | Description             |
| ------ | ---------------------------- | -------- | ----------------------- |
| `mode` | `'cell' \| 'row' \| 'range'` | `'cell'` | Selection behavior mode |
| `enabled` | `boolean` | `true` | Plugin-level enable/disable (same effect as `gridConfig.selectable`) |
| `triggerOn` | `'click' \| 'dblclick'` | `'click'` | Selection trigger type |
| `isSelectable` | `(row, rowIndex, column?, colIndex?) => boolean` | `undefined` | Callback to conditionally disable selection |

### Double-Click Selection Trigger

In data-entry grids where users navigate frequently, you may want single-click to only **focus** the row/cell for keyboard navigation, while **double-click** changes the selection state. This prevents accidental selection changes during navigation.

> **Note:** `triggerOn` only applies to `'cell'` and `'row'` modes. Range mode uses drag selection (mousedown → mousemove), which is unaffected by this setting.

```ts
new SelectionPlugin({
  mode: 'row',
  triggerOn: 'dblclick',  // Single-click focuses, double-click selects
})
```

| `triggerOn` | Single Click | Double Click |
|-------------|--------------|--------------|
| `'click'` (default) | Selects cell/row | No additional action |
| `'dblclick'` | Focuses only | Selects cell/row |

### Conditional Selection

Use the `isSelectable` callback to prevent selection of specific rows or cells based on their data. This is useful for:

- Locked/read-only records that shouldn't be selected
- Permission-based selection restrictions
- Excluding specific columns from selection (cell/range modes)

<Canvas of={SelectionStories.ConditionalSelection} withToolbar />

```ts
new SelectionPlugin({
  mode: 'row',
  // Prevent selection of locked rows
  isSelectable: (row) => row.status !== 'locked',
})
```

**Behavior of non-selectable rows/cells:**

| Aspect | Behavior |
|--------|----------|
| Click | Ignored (no selection change) |
| Keyboard | Skipped when navigating with Shift+Arrow |
| Select All (Ctrl+A) | Excluded from selection |
| Visual | Muted styling via `[data-selectable="false"]` attribute |
| Focus | Still navigable (arrow keys can move through them) |

**Mode-specific parameters:**

| Mode | Parameters Provided |
|------|---------------------|
| `row` | `row`, `rowIndex` |
| `cell` / `range` | `row`, `rowIndex`, `column`, `colIndex` |

```ts
// Cell mode: prevent selection of the ID column
new SelectionPlugin({
  mode: 'cell',
  isSelectable: (row, rowIndex, column) => column?.field !== 'id',
})
```

## Keyboard Shortcuts

The plugin provides full keyboard support for accessibility and power users:

| Shortcut        | Action                          |
| --------------- | ------------------------------- |
| `Arrow Keys`    | Move selection                  |
| `Shift + Arrow` | Extend selection (range mode)   |
| `Ctrl + Click`  | Toggle selection (multi-select) |
| `Shift + Click` | Extend to clicked cell/row      |
| `Ctrl + A`      | Select all (range mode)         |
| `Escape`        | Clear selection                 |

## Programmatic API

You can control selection programmatically via the plugin instance:

```ts
// Get the plugin instance from the grid
const plugin = grid.getPlugin(SelectionPlugin);

// Select specific cells/rows
plugin.selectCell(rowIndex, colIndex);
plugin.selectRow(rowIndex);
plugin.selectRange({ from: { row: 0, col: 0 }, to: { row: 5, col: 3 } });

// Query current selection
const ranges = plugin.getSelectedRanges();
const selectedRows = plugin.getSelectedRows();

// Modify selection
plugin.clearSelection();
plugin.selectAll();
```

## Events

The SelectionPlugin emits events when selection changes. Click cells, rows, or use
Shift+Click for ranges to see the events:

<Canvas of={SelectionStories.SelectionEvents} withToolbar />

| Event | Description |
| ----- | ----------- |
| `selection-change` | Fired when the selection is modified |

### `selection-change` Detail

```ts
interface SelectionChangeDetail {
  mode: SelectionMode;  // 'cell' | 'row' | 'range'
  ranges: CellRange[];  // Array of selected ranges
}
```

## Styling

The selection plugin supports CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-focus-background` | `rgba(accent, 12%)` | Focused row background |
| `--tbw-range-selection-bg` | `rgba(accent, 12%)` | Range selection fill |
| `--tbw-range-border-color` | `var(--tbw-color-accent)` | Range selection border |
| `--tbw-color-accent` | `#3b82f6` | Primary accent color |
| `--tbw-font-size-sm` | `0.9285em` | Selection summary text |
| `--tbw-color-fg-muted` | `#888` | Summary text color |

### Example

```css
tbw-grid {
  /* Custom selection styling */
  --tbw-range-selection-bg: rgba(76, 175, 80, 0.15);
  --tbw-range-border-color: #4caf50;
  --tbw-focus-background: rgba(76, 175, 80, 0.1);
}
```

### CSS Classes

The selection plugin uses these class names:

| Class | Element |
| --- | --- |
| `.selecting` | Grid during range drag (disables text selection) |
| `.row-focus` | Currently focused row (row mode) |
| `.cell-focus` | Currently focused cell (cell mode) |
| `.selected` | Selected cell in range |
| `.selected.top` | Top edge of selection range |
| `.selected.bottom` | Bottom edge of selection range |
| `.selected.first` | Left edge of selection range |
| `.selected.last` | Right edge of selection range |
| `.tbw-selection-summary` | Selection count in header |

## See Also

- **[Clipboard](../?path=/docs/grid-plugins-clipboard--docs)** — Copy/paste selected cells
- **[Editing](../?path=/docs/grid-plugins-editing--docs)** — Inline cell editing
- **[Filtering](../?path=/docs/grid-plugins-filtering--docs)** — Filter visible rows
- **[Accessibility](../?path=/docs/grid-accessibility--docs)** — Keyboard navigation reference
