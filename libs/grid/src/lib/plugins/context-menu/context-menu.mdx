import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as ContextMenuStories from './context-menu.stories';

<Meta of={ContextMenuStories} />

# Context Menu Plugin

The Context Menu plugin adds a customizable right-click menu to your grid cells. Build anything from simple copy/paste actions to complex nested menus with conditional visibility, icons, and keyboard shortcuts.

## Installation

```ts
import { ContextMenuPlugin } from '@toolbox-web/grid/plugins/context-menu';
```

## Basic Usage

Define your menu items as an arrayâ€”each item has an `id`, `label`, and `action` callback that receives context about the clicked cell (row data, column info, cell value, etc.). Add separators between groups of actions for visual clarity.

<Tabs>
  <Tab label="Vanilla JS">
```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'name', header: 'Name' },
    { field: 'email', header: 'Email' },
    { field: 'status', header: 'Status' }
  ],
  plugins: [
    new ContextMenuPlugin({
      items: [
        { id: 'copy', label: 'Copy Cell', action: (ctx) => navigator.clipboard.writeText(ctx.value) },
        { id: 'edit', label: 'Edit Row', action: (ctx) => grid.startEditing(ctx.rowIndex, ctx.colIndex) },
        { type: 'separator' },
        { id: 'delete', label: 'Delete Row', action: (ctx) => removeRow(ctx.rowIndex) },
      ],
    }),
  ],
};
```
  </Tab>
  <Tab label="React">
```tsx
import '@toolbox-web/grid-react/features/context-menu';
import { DataGrid, useGrid } from '@toolbox-web/grid-react';
import type { ContextMenuConfig } from '@toolbox-web/grid/plugins/context-menu';

function MyGrid({ data, onDelete }) {
  const { gridRef } = useGrid();

  const contextMenu: ContextMenuConfig = {
    items: [
      { id: 'copy', label: 'Copy Cell', action: (ctx) => navigator.clipboard.writeText(ctx.value) },
      { id: 'edit', label: 'Edit Row', action: (ctx) => gridRef.current?.startEditing(ctx.rowIndex, ctx.colIndex) },
      { type: 'separator' },
      { id: 'delete', label: 'Delete Row', action: (ctx) => onDelete(ctx.rowIndex) },
    ],
  };

  return (
    <DataGrid
      ref={gridRef}
      rows={data}
      columns={[
        { field: 'name', header: 'Name' },
        { field: 'email', header: 'Email' },
        { field: 'status', header: 'Status' }
      ]}
      contextMenu={contextMenu}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```html
<script setup>
import { TbwGrid, TbwGridColumn } from '@toolbox-web/grid-vue';
import { ContextMenuPlugin } from '@toolbox-web/grid/plugins/context-menu';
import { ref, markRaw } from 'vue';

const data = [
  { name: 'Alice', email: 'alice@example.com', status: 'active' },
  { name: 'Bob', email: 'bob@example.com', status: 'inactive' },
];

const gridRef = ref(null);

const contextMenuPlugin = markRaw(new ContextMenuPlugin({
  items: [
    { id: 'copy', label: 'Copy Cell', action: (ctx) => navigator.clipboard.writeText(String(ctx.value)) },
    { id: 'edit', label: 'Edit Row', action: (ctx) => gridRef.value?.element?.startEditing(ctx.rowIndex, ctx.colIndex) },
    { type: 'separator' },
    { id: 'delete', label: 'Delete Row', action: (ctx) => console.log('Delete row:', ctx.rowIndex) },
  ],
}));
</script>

<template>
  <TbwGrid ref="gridRef" :rows="data" :plugins="[contextMenuPlugin]">
    <TbwGridColumn field="name" header="Name" />
    <TbwGridColumn field="email" header="Email" />
    <TbwGridColumn field="status" header="Status" />
  </TbwGrid>
</template>
```
  </Tab>
  <Tab label="Angular">
```typescript
// Feature import - enables the [contextMenu] input
import '@toolbox-web/grid-angular/features/context-menu';

import { Component, output, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig, ContextMenuItem } from '@toolbox-web/grid';

@Component({
  selector: 'app-my-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      #grid
      [rows]="rows"
      [columns]="columns"
      [contextMenu]="contextMenuConfig"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class MyGridComponent {
  deleteRow = output<number>();
  rows = [...];

  columns: ColumnConfig[] = [
    { field: 'name', header: 'Name' },
    { field: 'email', header: 'Email' },
    { field: 'status', header: 'Status' }
  ];

  contextMenuConfig = {
    items: [
      { id: 'copy', label: 'Copy Cell', action: (ctx: any) => navigator.clipboard.writeText(ctx.value) },
      { id: 'edit', label: 'Edit Row', action: (ctx: any) => (document.querySelector('tbw-grid') as any).startEditing(ctx.rowIndex, ctx.colIndex) },
      { type: 'separator' },
      { id: 'delete', label: 'Delete Row', action: (ctx: any) => this.deleteRow.emit(ctx.rowIndex) },
    ] as ContextMenuItem[],
  };
}
```
  </Tab>
</Tabs>

## Demos

### Default Context Menu

Right-click any cell to see the context menu.

<Canvas of={ContextMenuStories.Default} withToolbar />
<Controls of={ContextMenuStories.Default} />

### With Submenus

Nested menu items for complex actions.

<Canvas of={ContextMenuStories.WithSubmenus} withToolbar />

### Conditional Items

Show/hide items based on context.

<Canvas of={ContextMenuStories.ConditionalItems} withToolbar />

## Configuration Options

| Option  | Type         | Default | Description           |
| ------- | ------------ | ------- | --------------------- |
| `items` | `MenuItem[]` | `[]`    | Menu items to display |

## Menu Item Types

```ts
interface MenuItem {
  id: string;
  label: string;
  icon?: string; // Icon class or HTML
  action?: (ctx: MenuContext) => void;
  disabled?: boolean | ((ctx: MenuContext) => boolean);
  visible?: boolean | ((ctx: MenuContext) => boolean);
  items?: MenuItem[]; // Submenu items
}

interface SeparatorItem {
  type: 'separator';
}
```

## Menu Context

The action callback receives context about the clicked cell:

```ts
interface MenuContext {
  rowIndex: number;
  colIndex: number;
  field: string;
  value: any;
  row: any;
  column: ColumnConfig;
}
```

## Conditional Items

```ts
new ContextMenuPlugin({
  items: [
    {
      id: 'edit',
      label: 'Edit',
      visible: (ctx) => ctx.column.editable === true,
    },
    {
      id: 'delete',
      label: 'Delete',
      disabled: (ctx) => ctx.row.locked === true,
    },
  ],
});
```

## Events

| Event               | Detail              | Description |     |
| ------------------- | ------------------- | ----------- | --- |
| `context-menu-open` | `{ params, items }` | Menu opened |

## Styling

The context menu supports CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-context-menu-bg` | `var(--tbw-color-panel-bg)` | Menu background |
| `--tbw-context-menu-fg` | `var(--tbw-color-fg)` | Menu text color |
| `--tbw-context-menu-border` | `var(--tbw-color-border)` | Menu border |
| `--tbw-context-menu-hover` | `var(--tbw-color-row-hover)` | Item hover background |
| `--tbw-menu-min-width` | `10rem` | Minimum menu width |
| `--tbw-menu-item-padding` | `0.375rem 0.75rem` | Menu item padding |
| `--tbw-menu-item-gap` | `0.5rem` | Gap between icon and label |
| `--tbw-font-size-sm` | `0.9285em` | Menu font size |
| `--tbw-font-size-xs` | `0.7857em` | Shortcut text size |
| `--tbw-icon-size` | `1em` | Icon width |

### Example

```css
tbw-grid {
  /* Custom context menu styling */
  --tbw-context-menu-bg: #2d2d2d;
  --tbw-context-menu-fg: #ffffff;
  --tbw-context-menu-border: #444444;
  --tbw-context-menu-hover: #3d3d3d;
  --tbw-menu-item-padding: 0.5rem 1rem;
}
```

### CSS Classes

The menu uses these class names for advanced customization:

| Class | Element |
| --- | --- |
| `.tbw-context-menu` | Menu container |
| `.tbw-context-menu-item` | Menu item row |
| `.tbw-context-menu-item.disabled` | Disabled item |
| `.tbw-context-menu-item.danger` | Danger/delete action |
| `.tbw-context-menu-icon` | Item icon container |
| `.tbw-context-menu-label` | Item label text |
| `.tbw-context-menu-shortcut` | Keyboard shortcut |
| `.tbw-context-menu-separator` | Divider line |
