import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as RowReorderStories from './row-reorder.stories';

<Meta of={RowReorderStories} />

# Row Reorder Plugin

The Row Reorder plugin lets users rearrange rows by dragging a grip handle or using keyboard shortcuts. Ideal for priority lists, task ordering, or any data where sequence matters.

## Installation

```ts
import { RowReorderPlugin } from '@toolbox-web/grid/plugins/row-reorder';
```

## Basic Usage

Add the plugin and a drag handle column appears automatically. Users can drag rows to new positions or use Ctrl+Up/Down to move the focused row.

<Tabs>
  <Tab label="Vanilla JS">
```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'priority', header: '#', type: 'number', width: 50 },
    { field: 'task', header: 'Task' },
    { field: 'status', header: 'Status' },
  ],
  plugins: [
    new RowReorderPlugin({
      handlePosition: 'start',
      keyboardEnabled: true,
      animation: 'flip',
    }),
  ],
};

// Listen for row moves
grid.addEventListener('row-move', (e) => {
  console.log(`Moved row from ${e.detail.fromIndex} to ${e.detail.toIndex}`);
  // Optionally persist the new order to your backend
});
```
  </Tab>
  <Tab label="React">
```tsx
import '@toolbox-web/grid-react/features/row-reorder';
import { DataGrid } from '@toolbox-web/grid-react';

function ReorderableTaskList({ tasks }) {
  return (
    <DataGrid
      rows={tasks}
      columns={[
        { field: 'priority', header: '#', type: 'number', width: 50 },
        { field: 'task', header: 'Task' },
        { field: 'status', header: 'Status' },
      ]}
      rowReorder
      onRowMove={(e) => console.log('Row moved:', e.detail)}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```vue
<template>
  <tbw-grid ref="gridRef" @row-move="onRowMove" />
</template>

<script setup>
import { ref, onMounted } from 'vue';
import '@toolbox-web/grid';
import { RowReorderPlugin } from '@toolbox-web/grid/plugins/row-reorder';

const props = defineProps(['tasks']);
const gridRef = ref(null);

onMounted(() => {
  gridRef.value.gridConfig = {
    columns: [
      { field: 'priority', header: '#', type: 'number', width: 50 },
      { field: 'task', header: 'Task' },
      { field: 'status', header: 'Status' },
    ],
    plugins: [new RowReorderPlugin()],
  };
  gridRef.value.rows = props.tasks;
});

const onRowMove = (e) => {
  console.log('Row moved:', e.detail);
};
</script>
```
  </Tab>
  <Tab label="Angular">
```typescript
// Feature import - enables the [rowReorder] input
import '@toolbox-web/grid-angular/features/row-reorder';

import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-task-list',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="rows"
      [columns]="columns"
      [rowReorder]="true"
      (row-move)="onRowMove($event)"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class TaskListComponent {
  rows = [
    { priority: 1, task: 'Review PR', status: 'Pending' },
    { priority: 2, task: 'Deploy staging', status: 'In Progress' },
  ];

  columns: ColumnConfig[] = [
    { field: 'priority', header: '#', type: 'number', width: 50 },
    { field: 'task', header: 'Task' },
    { field: 'status', header: 'Status' },
  ];

  onRowMove(e: CustomEvent) {
    console.log('Row moved:', e.detail);
  }
}
```
  </Tab>
</Tabs>

## Demos

### Default Row Reorder

Drag the grip handle (☰) to reorder rows. Use Ctrl+Up/Down to move the focused row with the keyboard.

<Canvas of={RowReorderStories.Default} withToolbar />
<Controls of={RowReorderStories.Default} />

### Handle at End

The drag handle can be placed at the end (right side) of each row instead of the left.

<Canvas of={RowReorderStories.HandleAtEnd} />

### Cancelable Events

Cancel row moves by calling `event.preventDefault()` in the `row-move` handler.

<Canvas of={RowReorderStories.CancelableEvent} />

## Configuration Options

| Option              | Type                                                              | Default   | Description                                                       |
| ------------------- | ----------------------------------------------------------------- | --------- | ----------------------------------------------------------------- |
| `showDragHandle`    | `boolean`                                                         | `true`    | Show drag handle column for drag-and-drop reordering              |
| `dragHandlePosition`| `'left' \| 'right'`                                               | `'left'`  | Position of the drag handle column                                |
| `dragHandleWidth`   | `number`                                                          | `40`      | Width of the drag handle column in pixels                         |
| `enableKeyboard`    | `boolean`                                                         | `true`    | Enable Ctrl+Up/Down keyboard shortcuts                            |
| `canMove`           | `(row, fromIndex, toIndex, direction) => boolean`                 | -         | Validation callback to allow/prevent moves                        |
| `debounceMs`        | `number`                                                          | `150`     | Debounce time for rapid keyboard moves                            |
| `animation`         | `false \| 'flip'`                                                 | `'flip'`  | Animation type: `false` (instant), `'flip'` (FLIP animation)      |

## TypeScript Interfaces

```ts
import { RowReorderPlugin, RowReorderConfig, RowMoveDetail } from '@toolbox-web/grid/plugins/row-reorder';

/**
 * Configuration options for the RowReorderPlugin.
 */
interface RowReorderConfig {
  enableKeyboard?: boolean;       // Enable Ctrl+Up/Down shortcuts (default: true)
  showDragHandle?: boolean;       // Show drag handle column (default: true)
  dragHandlePosition?: 'left' | 'right';  // Drag handle column position (default: 'left')
  dragHandleWidth?: number;       // Drag handle column width in px (default: 40)
  canMove?: <T>(row: T, fromIndex: number, toIndex: number, direction: 'up' | 'down') => boolean;
  debounceMs?: number;            // Debounce time for keyboard moves (default: 150)
  animation?: false | 'flip';     // Animation type (default: 'flip')
}

/**
 * Event detail emitted when a row is moved.
 */
interface RowMoveDetail<T = unknown> {
  row: T;           // The row that was moved
  fromIndex: number; // The original index of the row
  toIndex: number;   // The new index of the row
  rows: T[];         // The full rows array in new order
  source: 'keyboard' | 'drag';  // How the move was initiated
}
```

## Events

| Event      | Detail           | Cancelable | Description                                                  |
| ---------- | ---------------- | ---------- | ------------------------------------------------------------ |
| `row-move` | `RowMoveDetail`  | Yes        | Fired when a row move is attempted. Call `preventDefault()` to block. |

### Event Detail Properties

| Property    | Type                   | Description                                      |
| ----------- | ---------------------- | ------------------------------------------------ |
| `row`       | `T`                    | The row object being moved                       |
| `fromIndex` | `number`               | Original index in the rows array                 |
| `toIndex`   | `number`               | Target index after the move                      |
| `rows`      | `T[]`                  | Complete rows array after reordering             |
| `source`    | `'keyboard' \| 'drag'` | How the move was initiated                       |

## Keyboard Support

| Key          | Action                    |
| ------------ | ------------------------- |
| `Ctrl + ↑`   | Move focused row up       |
| `Ctrl + ↓`   | Move focused row down     |

## Styling

The plugin adds these CSS classes you can customize:

| Class                          | Description                                        |
| ------------------------------ | -------------------------------------------------- |
| `.dg-row-drag-handle`          | The drag handle cell                               |
| `.dg-row-drag-handle:hover`    | Handle hover state                                 |
| `.dg-row.dragging`             | Row currently being dragged                        |
| `.dg-row.drop-target`          | Row being hovered as drop target                   |
| `.dg-row.drop-before`          | Drop indicator showing insertion above             |
| `.dg-row.drop-after`           | Drop indicator showing insertion below             |

### Custom Handle Icon

Override the default grip icon via CSS:

```css
.dg-row-drag-handle::before {
  content: '⋮⋮'; /* Double vertical ellipsis */
}
```

## Notes

- **Row Identification**: Uses `getRowId()` from `GridConfig` if defined, otherwise falls back to array index.
- **Data Mutation**: The plugin reorders `grid.rows` in place. The `row-move` event provides the updated array.
- **Virtualization**: Works with virtualized grids - only visible rows are rendered but logical indices are preserved.
- **Keyboard Debounce**: Rapid keyboard moves are debounced (150ms) to prevent excessive rerenders.
