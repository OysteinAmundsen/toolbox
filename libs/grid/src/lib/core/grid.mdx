import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../apps/docs/.storybook/components/Tabs';
import * as GridStories from './grid.stories';
import * as HeaderRendererStories from './header-renderers.stories';
import * as LoadingPlaygroundStories from './loading-playground.stories';

<Meta of={GridStories} />

# Core Grid Component

The `<tbw-grid>` is a high-performance, framework-agnostic data grid web component built with pure TypeScript.

## Features

| Feature                    | Description                                          |
| -------------------------- | ---------------------------------------------------- |
| üöÄ **Virtualization**      | Handles 100k+ rows with smooth scrolling             |
| üîß **Framework Agnostic**  | Works in vanilla JS, React, Vue, Angular, Svelte     |
| ‚å®Ô∏è **Keyboard Navigation** | Full arrow key, Tab, Enter, Escape support           |
| üé® **Themeable**           | CSS custom properties for complete customization     |
| üì¶ **Plugin Architecture** | Extend with selection, filtering, grouping, and more |

## Installation

```bash
npm install @toolbox-web/grid
```

## Basic Usage

<Tabs>
  <Tab label="Vanilla JS">
```html
<tbw-grid style="height: 400px;"></tbw-grid>

<script type="module">
  import '@toolbox-web/grid';
  import { queryGrid } from '@toolbox-web/grid';

  const grid = queryGrid('tbw-grid');
  grid.columns = [
    { field: 'id', header: 'ID', type: 'number' },
    { field: 'name', header: 'Name', sortable: true },
    { field: 'email', header: 'Email' },
  ];
  grid.rows = [
    { id: 1, name: 'Alice', email: 'alice@example.com' },
    { id: 2, name: 'Bob', email: 'bob@example.com' },
  ];
</script>
```
  </Tab>
  <Tab label="React">
```tsx
import { DataGrid } from '@toolbox-web/grid-react';

const data = [
  { id: 1, name: 'Alice', email: 'alice@example.com' },
  { id: 2, name: 'Bob', email: 'bob@example.com' },
];

function MyGrid() {
  return (
    <DataGrid
      rows={data}
      columns={[
        { field: 'id', header: 'ID', type: 'number' },
        { field: 'name', header: 'Name', sortable: true },
        { field: 'email', header: 'Email' },
      ]}
      style={{ height: '400px' }}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```vue
<template>
  <tbw-grid ref="gridRef" style="height: 400px" />
</template>

<script setup>
import '@toolbox-web/grid';
import { ref, onMounted } from 'vue';

const gridRef = ref(null);
const data = [
  { id: 1, name: 'Alice', email: 'alice@example.com' },
  { id: 2, name: 'Bob', email: 'bob@example.com' },
];

onMounted(() => {
  gridRef.value.columns = [
    { field: 'id', header: 'ID', type: 'number' },
    { field: 'name', header: 'Name', sortable: true },
    { field: 'email', header: 'Email' },
  ];
  gridRef.value.rows = data;
});
</script>
```
  </Tab>
  <Tab label="Angular">
```typescript
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-my-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="rows"
      [columns]="columns"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class MyGridComponent {
  rows = [
    { id: 1, name: 'Alice', email: 'alice@example.com' },
    { id: 2, name: 'Bob', email: 'bob@example.com' },
  ];

  columns: ColumnConfig[] = [
    { field: 'id', header: 'ID', type: 'number' },
    { field: 'name', header: 'Name', sortable: true },
    { field: 'email', header: 'Email' },
  ];
}
```
  </Tab>
</Tabs>

### Interactive Playground

Experiment with all core grid options using the controls below. [Open with controls ‚Üí](?path=/story/grid-core--playground)

<Canvas of={GridStories.Playground} withToolbar />
<Controls of={GridStories.Playground} exclude={['fixedHeight']} />

### Keyboard Navigation

The grid implements [ARIA grid keyboard patterns](https://www.w3.org/WAI/ARIA/apg/patterns/grid/) out of the box‚Äîno configuration required:

| Key                      | Action                       |
| ------------------------ | ---------------------------- |
| `‚Üë` `‚Üì` `‚Üê` `‚Üí`          | Navigate cells               |
| `Tab` / `Shift+Tab`      | Move to next/previous cell   |
| `Enter`                  | Start editing / confirm edit |
| `Escape`                 | Cancel editing               |
| `Home` / `End`           | Jump to first/last column    |
| `Ctrl+Home` / `Ctrl+End` | Jump to first/last row       |
| `Page Up` / `Page Down`  | Scroll by viewport           |


## Configuration
### Column Inference

**Zero-config data display** ‚Äî Just pass your data and the grid figures out the rest.

When you provide `rows` without defining `columns`, the grid automatically:
- Detects fields from the first row's property names
- Infers data types (`string`, `number`, `boolean`, `date`) from actual values
- Generates human-readable headers from field names (`firstName` ‚Üí `First Name`)
- Applies appropriate sorting and formatting for each type

This means you can display data with a single line of code:

```typescript
grid.rows = myData;  // That's it!
```

<Canvas of={GridStories.ColumnInference} withToolbar />

### Light DOM Columns

**Declarative configuration** ‚Äî Define columns in HTML instead of JavaScript.

If you need more control than automatic inference provides, you don't have to write JavaScript configuration. Use `<tbw-grid-column>` elements to declaratively define columns, headers, widths, and other properties directly in your markup:

```html
<tbw-grid>
  <tbw-grid-column field="id" header="ID" width="80"></tbw-grid-column>
  <tbw-grid-column field="name" header="Full Name" sortable></tbw-grid-column>
  <tbw-grid-column field="email" header="Email Address"></tbw-grid-column>
</tbw-grid>
```

This approach is ideal for:
- **Static layouts** where columns don't change at runtime
- **Server-rendered pages** where HTML is generated on the server
- **Template-driven frameworks** like Angular or Vue that prefer declarative syntax
- **Quick prototyping** without writing JavaScript

The grid also supports other light DOM elements like `<tbw-grid-header>` for shell configuration ‚Äî see [Shell Components](#shell-components) below.

<Canvas of={GridStories.LightDOMColumns} withToolbar />

### Configuration Reference

For complete property documentation, see the API reference:

- [`GridConfig`](/docs/grid-api-core-interfaces-gridconfig--docs) ‚Äî Grid-level options (fitMode, sortable, plugins, etc.)
- [`ColumnConfig`](/docs/grid-api-core-interfaces-columnconfig--docs) ‚Äî Column-level options (field, header, width, renderer, etc.)


## Presentation
### Formatters

**Transform how values are displayed** ‚Äî Formatters convert raw data values into user-friendly text.

A formatter is a function that takes a cell value and returns a formatted string. Use formatters for:
- **Currency**: `1234.50` ‚Üí `$1,234.50`
- **Dates**: `2024-01-15` ‚Üí `January 15, 2024`
- **Percentages**: `0.156` ‚Üí `15.6%`
- **Prefixes/suffixes**: `42` ‚Üí `42 kg` or `#42`

```typescript
grid.columns = [
  {
    field: 'salary',
    format: (value) => `$${value.toLocaleString()}`,
  },
];
```

<Canvas of={GridStories.CustomFormatters} withToolbar />

### Row Styling

**Style entire rows** based on data properties like status, role, or priority using the `rowClass` callback.

```typescript
grid.gridConfig = {
  rowClass: (row) => row.status === 'inactive' ? 'row-inactive' : '',
};
```

<Canvas of={GridStories.RowClass} withToolbar />

### Cell Styling

**Style individual cells** based on their value ‚Äî perfect for data validation, conditional formatting, or highlighting.

```typescript
grid.columns = [
  {
    field: 'score',
    cellClass: (value) => {
      if (value >= 90) return 'cell-success';
      if (value < 50) return 'cell-danger';
      return '';
    },
  },
];
```

<Canvas of={GridStories.CellClass} withToolbar />

> **Tip:** You can combine `rowClass` and `cellClass`. When styles conflict, cell styles win because cells are children of rows in the DOM hierarchy.

### Row Animation

The grid provides a built-in row animation API for highlighting changes, insertions, and removals with visual feedback.

| Type | Description | CSS Variable |
|------|-------------|--------------|
| `'change'` | Flash highlight for data changes | `--tbw-row-change-duration` (500ms) |
| `'insert'` | Slide-in animation for new rows | `--tbw-row-insert-duration` (300ms) |
| `'remove'` | Fade-out animation for removed rows | `--tbw-row-remove-duration` (200ms) |

```typescript
// Highlight a row after updating
grid.rows[5].status = 'updated';
grid.animateRow(5, 'change');

// Animate a newly inserted row
grid.rows = [...grid.rows, newRow];
grid.animateRow(grid.rows.length - 1, 'insert');

// Animate by row ID (stable when sorted/filtered)
grid.animateRowById(data.id, 'change');

// Animate multiple rows at once
grid.animateRows([0, 2, 5], 'change');
```

**Automatic Animation:** When using the **EditingPlugin**, rows are automatically animated with `'change'` after a successful edit commit.

**Customizing Appearance:**

```css
tbw-grid {
  --tbw-row-change-duration: 750ms;
  --tbw-row-change-color: rgba(34, 197, 94, 0.25); /* Green flash */
}
```

<Canvas of={GridStories.RowAnimation} withToolbar />

### Renderers

**Full control over cell content** ‚Äî Renderers let you create custom HTML elements for cells.

While formatters return plain text, renderers return DOM elements. Use renderers when you need:
- **Custom components**: Checkboxes, badges, progress bars, buttons
- **Interactive elements**: Links, icons, action buttons
- **Rich formatting**: Multiple elements, images, complex layouts

```typescript
grid.columns = [
  {
    field: 'status',
    header: 'Status',
    renderer: (ctx) => {
      const badge = document.createElement('span');
      badge.className = `badge badge-${ctx.value}`;
      badge.textContent = ctx.value as string;
      return badge;
    },
  },
  {
    field: 'active',
    header: 'Active',
    renderer: (ctx) => {
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = !!ctx.value;
      checkbox.disabled = true;
      return checkbox;
    },
  },
];
```

The renderer context (`ctx`) provides:
- `value` ‚Äî The cell's data value
- `row` ‚Äî The full row data object
- `column` ‚Äî The column configuration
- `rowIndex` ‚Äî The row's index in the data

### Type-Level Defaults

Define default formatters and renderers for all columns of a specific `type`.

```typescript
import { queryGrid } from '@toolbox-web/grid';

const grid = queryGrid('tbw-grid');
grid.gridConfig = {
  typeDefaults: {
    // All columns with type: 'currency' use this formatter
    currency: {
      format: (value) => new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
      }).format(value as number),
    },
    // All columns with type: 'boolean' use this renderer
    boolean: {
      renderer: (ctx) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!ctx.value;
        checkbox.disabled = true;
        return checkbox;
      },
    },
    // Custom type for status badges
    status: {
      renderer: (ctx) => {
        const badge = document.createElement('span');
        badge.className = `status-badge status-${ctx.value}`;
        badge.textContent = ctx.value as string;
        return badge;
      },
    },
  },
  columns: [
    { field: 'salary', type: 'currency' },  // Uses currency formatter
    { field: 'active', type: 'boolean' },   // Uses boolean renderer
    { field: 'status', type: 'status' },    // Uses status renderer
  ],
};
```

**Resolution Priority**: Column-level ‚Üí Grid `typeDefaults` ‚Üí App-level (framework adapter) ‚Üí Built-in

> **Note:** `typeDefaults` also supports `editor`, `editorParams`, and `filterPanelRenderer`, but those require the [EditingPlugin](?path=/docs/grid-plugins-editing--docs#type-level-defaults) or [FilteringPlugin](?path=/docs/grid-plugins-filtering--docs) respectively.

### Custom Header Renderers

Customize column headers with two levels of control:

- **`headerLabelRenderer`** ‚Äî Customize just the label. Grid handles sort icons, filter buttons, and resize handles.
- **`headerRenderer`** ‚Äî Full control over header content. Use `ctx.renderSortIcon()` and `ctx.renderFilterButton()` (with FilteringPlugin) to include standard elements.

In this example, the **Name** column uses `headerLabelRenderer` to add a required indicator, while the **Email** column uses `headerRenderer` for complete control with a custom icon prefix:

<Canvas of={HeaderRendererStories.CustomHeaderRenderers} withToolbar />

## Column State Persistence

The grid tracks user modifications to columns‚Äîresizing, reordering, hiding, and sorting‚Äîand exposes this state for you to persist wherever makes sense for your application (localStorage, a backend API, user preferences service, etc.). The grid intentionally does **not** auto-store state; you control where and how it's saved.

#### What State Contains

The [`GridColumnState`](/docs/grid-api-core-interfaces-gridcolumnstate--docs) object captures everything needed to restore a user's column layout:

```ts
interface GridColumnState {
  columns: ColumnState[];
}

interface ColumnState {
  field: string;           // Column identifier
  order: number;           // Position in the grid (0-based)
  width?: number;          // Pixel width (if resized)
  visible: boolean;        // Hidden/shown state
  sort?: {
    direction: 'asc' | 'desc';
    priority: number;      // For multi-column sort
  };
}
```

#### Listening for Changes

Subscribe to the `column-state-change` event to detect when users modify columns:

```ts
grid.addEventListener('column-state-change', (e) => {
  const state = e.detail; // GridColumnState
  localStorage.setItem('grid-prefs', JSON.stringify(state));
  // Or: api.saveUserPreferences(userId, state);
});
```

The event fires (debounced) when users resize, reorder, hide/show, or sort columns.

#### Applying Saved State

Restore state on initialization via `gridConfig.columnState`:

```ts
const saved = localStorage.getItem('grid-prefs');
grid.gridConfig = {
  columns: [...],
  columnState: saved ? JSON.parse(saved) : undefined,
};
```

Or apply at runtime:

```ts
grid.columnState = JSON.parse(localStorage.getItem('grid-prefs'));
```

#### Resetting State

Reset to the original column configuration:

```ts
grid.resetColumnState();
localStorage.removeItem('grid-prefs');
```

<Canvas of={GridStories.ColumnStatePersistence} layout="fullscreen" withToolbar />

## Shell Components

The grid includes a shell wrapper for toolbar, tool panels, and status bar.

### Basic Shell

The shell provides a wrapper with toolbar, title, and optional tool panel sidebar.

<Canvas of={GridStories.ShellBasic} withToolbar />
<Controls of={GridStories.ShellBasic} />

### Configuration

Configure the shell via [`ShellConfig`](/docs/grid-api-core-interfaces-shellconfig--docs):

```ts
grid.gridConfig = {
  shell: {
    header: { title: 'Employee Directory' },
    toolPanel: { position: 'right', width: 280 },
  },
  plugins: [new VisibilityPlugin()], // Adds column visibility panel
};
```

#### Shell Header Layout

The shell header has four zones (left to right):

| Zone | Purpose | Configuration |
|------|---------|---------------|
| **Title** | Grid title text | `shell.header.title` or `<tbw-grid-header title="...">` |
| **Center** | Search boxes, filters, status | `registerHeaderContent()` or `<tbw-grid-header-content>` |
| **Toolbar** | Action buttons, controls | `shell.header.toolbarContents` or `registerToolbarContent()` or `<tbw-grid-tool-buttons>` |
| **Panel Toggle** | Opens tool panel sidebar | Automatic when plugins register panels |

#### Header Content (Center Area)

Add content to the center of the shell header using `registerHeaderContent()`:

```ts
grid.registerHeaderContent({
  id: 'row-count',
  order: 10,
  render: (container) => {
    const span = document.createElement('span');
    span.textContent = `${grid.rows.length} rows`;
    container.appendChild(span);
  },
});

// Remove later if needed
grid.unregisterHeaderContent('row-count');
```

See [`HeaderContentDefinition`](/docs/grid-api-core-interfaces-headercontentdefinition--docs) for all options.

#### Toolbar Content (Right Area)

Add custom buttons or controls to the toolbar using `shell.header.toolbarContents`:

```ts
grid.gridConfig = {
  shell: {
    header: {
      title: 'Employees',
      toolbarContents: [
        {
          id: 'export-btn',
          order: 10, // Lower = rendered first
          render: (container) => {
            const btn = document.createElement('button');
            btn.className = 'dg-toolbar-btn';
            btn.textContent = 'Export';
            btn.onclick = () => exportData(grid.rows);
            container.appendChild(btn);
          },
        },
      ],
    },
  },
};
```

Or register dynamically at runtime:

```ts
grid.registerToolbarContent({
  id: 'refresh-btn',
  order: 20,
  render: (container) => {
    const btn = document.createElement('button');
    btn.className = 'dg-toolbar-btn';
    btn.textContent = 'Refresh';
    btn.onclick = () => loadData();
    container.appendChild(btn);
  },
});

// Remove later if needed
grid.unregisterToolbarContent('refresh-btn');
```

See [`ToolbarContentDefinition`](/docs/grid-api-core-interfaces-toolbarcontentdefinition--docs) for all options.

#### Light DOM Shell Configuration

Configure the shell declaratively using `<tbw-grid-header>` elements. Set the title via attribute and add custom content with `<tbw-grid-header-content>`:

```html
<tbw-grid style="height: 500px; display: block;">
  <tbw-grid-header title="Employee Directory">
    <tbw-grid-header-content>
      <span style="color: #666;">20 employees</span>
    </tbw-grid-header-content>
  </tbw-grid-header>
</tbw-grid>

<script type="module">
import '@toolbox-web/grid';

const grid = document.querySelector('tbw-grid');
grid.columns = [...];
grid.rows = [...];
// Shell renders automatically from light DOM - no config needed!
</script>
```

### Multiple Tool Panels

Multiple plugins can register tool panels. The toolbar shows toggle buttons for each panel; clicking one opens it while closing any other open panel.

<Canvas of={GridStories.ShellMultiplePanels} withToolbar />

### Toolbar Buttons

Add custom toolbar buttons using the `<tbw-grid-tool-buttons>` container. Buttons are automatically styled and positioned in the toolbar.

<Canvas of={GridStories.ShellToolbarButtons} withToolbar />

## Loading States

The grid provides loading indicators at three levels: **grid** (full overlay), **row**, and **cell**. All loading states are user-controlled.

<Canvas of={LoadingPlaygroundStories.LoadingPlayground} withToolbar />
<Controls of={LoadingPlaygroundStories.LoadingPlayground} />

### API Reference

| Method | Description |
|--------|-------------|
| `grid.loading = boolean` | Show/hide grid-level overlay |
| `grid.setRowLoading(rowId, boolean)` | Show/hide row spinner |
| `grid.setCellLoading(rowId, field, boolean)` | Show/hide cell spinner |
| `grid.isRowLoading(rowId)` | Check if row is loading |
| `grid.isCellLoading(rowId, field)` | Check if cell is loading |
| `grid.clearAllLoading()` | Clear all loading states |

> **Note:** Row and cell loading require `getRowId` in your config to identify rows.

### Custom Loading Renderer

Replace the default spinner with a custom component:

<Canvas of={LoadingPlaygroundStories.CustomLoadingRenderer} withToolbar />

## Events

The core grid emits events for user interactions and state changes. Try clicking, sorting,
and resizing columns to see the events in the log:

<Canvas of={GridStories.CoreEvents} withToolbar />

### Core Grid Events

| Event                 | Detail                                       | Description                                     |
| --------------------- | -------------------------------------------- | ----------------------------------------------- |
| `cell-click`          | [`CellClickDetail`](/docs/grid-api-core-interfaces-cellclickdetail--docs) | Cell clicked                                    |
| `row-click`           | [`RowClickDetail`](/docs/grid-api-core-interfaces-rowclickdetail--docs) | Row clicked                                     |
| `cell-activate`       | [`CellActivateDetail`](/docs/grid-api-core-interfaces-cellactivatedetail--docs) | Cell activated via keyboard navigation          |
| `cell-change`         | [`CellChangeDetail`](/docs/grid-api-core-interfaces-cellchangedetail--docs) | Cell value changed (before commit)            |
| `sort-change`         | [`SortChangeDetail`](/docs/grid-api-core-interfaces-sortchangedetail--docs) | Sort state changed (0=none, 1=asc, -1=desc)     |
| `column-resize`       | [`ColumnResizeDetail`](/docs/grid-api-core-interfaces-columnresizedetail--docs) | Column width changed                            |
| `column-state-change` | [`GridColumnState`](/docs/grid-api-core-interfaces-gridcolumnstate--docs) | Column state (widths, order, visibility) changed |

## Methods

For the complete list of grid methods, see the [API Reference](?path=/docs/grid-api--docs#methods).
