import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import * as GroupingColumnsStories from './grouping-columns.stories';

<Meta of={GroupingColumnsStories} />

# Column Grouping Plugin

The Column Grouping plugin enables visual grouping of columns under shared headers.

## Installation

```ts
import { GroupingColumnsPlugin } from '@toolbox-web/grid/plugins/grouping-columns';
```

## Basic Usage

There are two ways to define column groups:

### Option 1: Declarative `columnGroups` (Recommended)

Define groups once at the grid level, referencing columns by field name:

```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columnGroups: [
    { id: 'personal', header: 'Personal Info', children: ['firstName', 'lastName', 'email'] },
    { id: 'work', header: 'Work Info', children: ['department', 'title', 'salary'] },
  ],
  columns: [
    { field: 'firstName', header: 'First Name' },
    { field: 'lastName', header: 'Last Name' },
    { field: 'email', header: 'Email' },
    { field: 'department', header: 'Department' },
    { field: 'title', header: 'Title' },
    { field: 'salary', header: 'Salary' },
  ],
  plugins: [new GroupingColumnsPlugin()],
};
```

### Option 2: Inline `group` Property

Add group information directly to each column:

```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'firstName', header: 'First Name', group: { id: 'personal', label: 'Personal Info' } },
    { field: 'lastName', header: 'Last Name', group: { id: 'personal', label: 'Personal Info' } },
    { field: 'department', header: 'Department', group: { id: 'work', label: 'Work Info' } },
  ],
  plugins: [new GroupingColumnsPlugin()],
};
```

You can also use a simple string for the group (the string becomes both the id and label):

```ts
{ field: 'firstName', header: 'First Name', group: 'Personal' }
```

## Demos

### Default Column Groups

<Canvas of={GroupingColumnsStories.Default} withToolbar />
<Controls of={GroupingColumnsStories.Default} />

### Without Borders

<Canvas of={GroupingColumnsStories.NoBorders} withToolbar />

## Configuration Options

### Plugin Options

| Option                | Type       | Default | Description                              |
| --------------------- | ---------- | ------- | ---------------------------------------- |
| `showGroupBorders`    | `boolean`  | `true`  | Show borders between groups              |
| `groupHeaderRenderer` | `function` | â€”       | Custom renderer for group header content |

### Grid Config: `columnGroups`

| Property   | Type       | Description                                |
| ---------- | ---------- | ------------------------------------------ |
| `id`       | `string`   | Unique group identifier                    |
| `header`   | `string`   | Display label for the group header         |
| `children` | `string[]` | Array of column field names in this group  |

### Column Config: `group`

| Type                              | Description                                         |
| --------------------------------- | --------------------------------------------------- |
| `string`                          | Simple group ID (used as both id and label)         |
| `{ id: string; label?: string }`  | Group object with explicit id and optional label    |

## API Methods

The plugin provides these methods on the plugin instance:

```ts
const plugin = grid.getPlugin(GroupingColumnsPlugin);

// Check if grouping is active
plugin.isGroupingActive(); // boolean

// Get all computed groups
plugin.getGroups(); // ColumnGroup[]

// Get columns in a specific group
plugin.getGroupColumns('personal'); // ColumnConfig[]

// Force refresh of column groups
plugin.refresh();
```
## Usage with Column Reordering

When using `GroupingColumnsPlugin` together with `ReorderPlugin`, be aware that **column reordering does not enforce group boundaries**. Users can drag columns out of their groups, which will cause the groups to be recomputed based on the new column order.

The `column-move` event is **cancelable**, so you can prevent moves that break group boundaries:

```ts
grid.addEventListener('column-move', (e) => {
  const { field, fromIndex, toIndex, columnOrder } = e.detail;

  // Example: prevent moves that break group boundaries
  if (!isValidMoveWithinGroup(field, fromIndex, toIndex)) {
    e.preventDefault(); // Column snaps back to original position
    return;
  }

  // Persist the new order
  saveColumnOrder(columnOrder);
});
```

The `column-move` event includes the complete `columnOrder` array, making it easy to persist user preferences.
