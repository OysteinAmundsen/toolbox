import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../apps/docs/.storybook/components/Tabs';
import * as GridStories from './grid.stories';
import * as HeaderRendererStories from './header-renderers.stories';

<Meta of={GridStories} />

# Core Grid Component

The `<tbw-grid>` is a high-performance, framework-agnostic data grid web component built with pure TypeScript.

## Features

| Feature                    | Description                                          |
| -------------------------- | ---------------------------------------------------- |
| üöÄ **Virtualization**      | Handles 100k+ rows with smooth scrolling             |
| üîß **Framework Agnostic**  | Works in vanilla JS, React, Vue, Angular, Svelte     |
| ‚å®Ô∏è **Keyboard Navigation** | Full arrow key, Tab, Enter, Escape support           |
| üé® **Themeable**           | CSS custom properties for complete customization     |
| üì¶ **Plugin Architecture** | Extend with selection, filtering, grouping, and more |

## Installation

```bash
npm install @toolbox-web/grid
```

## Basic Usage

<Tabs>
  <Tab label="Vanilla JS">
```html
<tbw-grid style="height: 400px;"></tbw-grid>

<script type="module">
  import '@toolbox-web/grid';

  const grid = document.querySelector('tbw-grid');
  grid.columns = [
    { field: 'id', header: 'ID', type: 'number' },
    { field: 'name', header: 'Name', sortable: true },
    { field: 'email', header: 'Email' },
  ];
  grid.rows = [
    { id: 1, name: 'Alice', email: 'alice@example.com' },
    { id: 2, name: 'Bob', email: 'bob@example.com' },
  ];
</script>
```
  </Tab>
  <Tab label="React">
```tsx
import { DataGrid } from '@toolbox-web/grid-react';

const data = [
  { id: 1, name: 'Alice', email: 'alice@example.com' },
  { id: 2, name: 'Bob', email: 'bob@example.com' },
];

function MyGrid() {
  return (
    <DataGrid
      rows={data}
      columns={[
        { field: 'id', header: 'ID', type: 'number' },
        { field: 'name', header: 'Name', sortable: true },
        { field: 'email', header: 'Email' },
      ]}
      style={{ height: '400px' }}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```vue
<template>
  <tbw-grid ref="gridRef" style="height: 400px" />
</template>

<script setup>
import '@toolbox-web/grid';
import { ref, onMounted } from 'vue';

const gridRef = ref(null);
const data = [
  { id: 1, name: 'Alice', email: 'alice@example.com' },
  { id: 2, name: 'Bob', email: 'bob@example.com' },
];

onMounted(() => {
  gridRef.value.columns = [
    { field: 'id', header: 'ID', type: 'number' },
    { field: 'name', header: 'Name', sortable: true },
    { field: 'email', header: 'Email' },
  ];
  gridRef.value.rows = data;
});
</script>
```
  </Tab>
  <Tab label="Angular">
```typescript
import { Component, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-my-grid',
  imports: [Grid],
  schemas: [CUSTOM_ELEMENTS_SCHEMA],
  template: `
    <tbw-grid
      [rows]="rows"
      [columns]="columns"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class MyGridComponent {
  rows = [
    { id: 1, name: 'Alice', email: 'alice@example.com' },
    { id: 2, name: 'Bob', email: 'bob@example.com' },
  ];

  columns: ColumnConfig[] = [
    { field: 'id', header: 'ID', type: 'number' },
    { field: 'name', header: 'Name', sortable: true },
    { field: 'email', header: 'Email' },
  ];
}
```
  </Tab>
</Tabs>

## Demos

### Interactive Playground

Experiment with all core grid options using the controls below. [Open with controls ‚Üí](?path=/story/grid-core--playground)

<Canvas of={GridStories.Playground} withToolbar />
<Controls of={GridStories.Playground} exclude={['fixedHeight']} />

### Column Inference

The grid can automatically infer column types from your data.

<Canvas of={GridStories.ColumnInference} withToolbar />

### Light DOM Columns

Define columns declaratively in HTML using `<tbw-grid-column>` elements.

<Canvas of={GridStories.LightDOMColumns} withToolbar />

### Custom Formatters

Use format functions and templates to customize cell display.

<Canvas of={GridStories.CustomFormatters} withToolbar />

### Type-Level Defaults

Define default formatters and renderers for all columns of a specific `type`. This is a **core feature** that works without any plugins.

```typescript
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  typeDefaults: {
    // All columns with type: 'currency' use this formatter
    currency: {
      format: (value) => new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
      }).format(value as number),
    },
    // All columns with type: 'boolean' use this renderer
    boolean: {
      renderer: (ctx) => {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!ctx.value;
        checkbox.disabled = true;
        return checkbox;
      },
    },
    // Custom type for status badges
    status: {
      renderer: (ctx) => {
        const badge = document.createElement('span');
        badge.className = `status-badge status-${ctx.value}`;
        badge.textContent = ctx.value as string;
        return badge;
      },
    },
  },
  columns: [
    { field: 'salary', type: 'currency' },  // Uses currency formatter
    { field: 'active', type: 'boolean' },   // Uses boolean renderer
    { field: 'status', type: 'status' },    // Uses status renderer
  ],
};
```

**Resolution Priority**: Column-level ‚Üí Grid `typeDefaults` ‚Üí App-level (framework adapter) ‚Üí Built-in

> **Note:** `typeDefaults` also supports `editor`, `editorParams`, and `filterPanelRenderer`, but those require the [EditingPlugin](?path=/docs/grid-plugins-editing--docs#type-level-defaults) or [FilteringPlugin](?path=/docs/grid-plugins-filtering--docs) respectively.

### Custom Header Renderers

Customize column headers with two levels of control:

- **`headerLabelRenderer`** - Customize only the label text. The grid automatically adds sort icons and resize handles.
- **`headerRenderer`** - Full control over the entire header cell. You receive helper functions to optionally include standard elements.

#### Header Label Renderer

Simple customizations like adding required indicators, units, or icons:

<Canvas of={HeaderRendererStories.HeaderLabelRenderer} withToolbar />

#### Full Header Renderer

Complete control for complex layouts. Use `ctx.renderSortIcon()` and `ctx.renderResizeHandle()` helpers:

<Canvas of={HeaderRendererStories.FullHeaderRenderer} withToolbar />

#### Comparing Approaches

See both approaches side-by-side to understand when to use each:

<Canvas of={HeaderRendererStories.ComparingApproaches} withToolbar />

### Dynamic Row & Cell Styling

Apply CSS classes dynamically based on row data or cell values using `rowClass` and `cellClass` callbacks.

#### Row Classes

Style entire rows based on data properties like status, role, or priority.

<Canvas of={GridStories.RowClass} withToolbar />

#### Cell Classes

Style individual cells based on their value - perfect for data validation or conditional formatting.

<Canvas of={GridStories.CellClass} withToolbar />

#### Combined Styling

Use both `rowClass` and `cellClass` together for comprehensive conditional styling.

<Canvas of={GridStories.CombinedDynamicClasses} withToolbar />

### Column State Persistence

Persist column widths, order, and visibility to localStorage.

<Canvas of={GridStories.ColumnStatePersistence} layout="fullscreen" withToolbar />

## Configuration

### Via Properties

```ts
const grid = document.querySelector('tbw-grid');
grid.columns = [...];
grid.rows = [...];
grid.fitMode = 'stretch'; // or 'fixed'
grid.sortable = true;     // grid-wide sorting toggle (default: true)
```

### Via gridConfig

```ts
grid.gridConfig = {
  columns: [...],
  fitMode: 'stretch',
  sortable: true, // grid-wide sorting toggle (default: true)
  plugins: [new EditingPlugin({ editOn: 'dblclick' })], // or 'click'
};
grid.rows = [...];
```

## Grid Configuration

| Property     | Type      | Default | Description                                      |
| ------------ | --------- | ------- | ------------------------------------------------ |
| `fitMode`    | `string`  | `'fixed'` | Column sizing: `'fixed'` or `'stretch'`        |
| `sortable`   | `boolean` | `true`  | Grid-wide sorting toggle. When `false`, disables sorting on all columns regardless of column-level `sortable` settings. |
| `filterable` | `boolean` | `true`  | Grid-wide filtering toggle. When `false`, disables filtering on all columns regardless of column-level `filterable` settings. Requires FilteringPlugin. |
| `selectable` | `boolean` | `true`  | Grid-wide selection toggle. When `false`, disables all selection. Requires SelectionPlugin. |

## Column Configuration

| Property    | Type                                          | Description                |
| ----------- | --------------------------------------------- | -------------------------- |
| `field`     | `string`                                      | Data field name (required) |
| `header`    | `string`                                      | Column header text         |
| `type`      | `'string' \| 'number' \| 'boolean' \| 'date'` | Data type                  |
| `width`     | `number`                                      | Fixed width in pixels      |
| `minWidth`  | `number`                                      | Minimum width              |
| `maxWidth`  | `number`                                      | Maximum width              |
| `sortable`  | `boolean`                                     | Enable sorting             |
| `editable`  | `boolean`                                     | Enable editing             |
| `resizable` | `boolean`                                     | Enable resizing            |
| `format`    | `(value, row) => string`                      | Custom formatter           |
| `template`  | `string`                                      | Template string            |

## Keyboard Shortcuts

| Key                      | Action                       |
| ------------------------ | ---------------------------- |
| `‚Üë` `‚Üì` `‚Üê` `‚Üí`          | Navigate cells               |
| `Tab` / `Shift+Tab`      | Move to next/previous cell   |
| `Enter`                  | Start editing / confirm edit |
| `Escape`                 | Cancel editing               |
| `Home` / `End`           | Jump to first/last column    |
| `Ctrl+Home` / `Ctrl+End` | Jump to first/last row       |
| `Page Up` / `Page Down`  | Scroll by viewport           |

## Shell Components

The grid includes a shell wrapper for toolbar, tool panels, and status bar.

### Basic Shell

The shell provides a wrapper with toolbar, title, and optional tool panel sidebar. Use the controls to explore different configurations.

<Canvas of={GridStories.ShellBasic} withToolbar />

### Light DOM Shell Configuration

Configure the shell declaratively using `<tbw-grid-header>` elements. Set the title via attribute and add custom content with `<tbw-grid-header-content>`.

<Canvas of={GridStories.ShellLightDOMConfig} withToolbar />

### Multiple Tool Panels

Multiple plugins can register tool panels. The toolbar shows toggle buttons for each panel; clicking one opens it while closing any other open panel.

<Canvas of={GridStories.ShellMultiplePanels} withToolbar />

### Toolbar Buttons

Add custom toolbar buttons using the `<tbw-grid-tool-buttons>` container. Buttons are automatically styled and positioned in the toolbar.

<Canvas of={GridStories.ShellToolbarButtons} withToolbar />

## Events

The core grid emits events for user interactions and state changes. Try clicking, sorting,
and resizing columns to see the events in the log:

<Canvas of={GridStories.CoreEvents} withToolbar />

### Core Grid Events

| Event                 | Detail                                       | Description                                     |
| --------------------- | -------------------------------------------- | ----------------------------------------------- |
| `cell-click`          | `{ row, rowIndex, field, value, ... }`       | Cell clicked                                    |
| `row-click`           | `{ row, rowIndex, rowEl, ... }`              | Row clicked                                     |
| `cell-activate`       | `{ rowIndex, colIndex, field, value, ... }`  | Cell activated via keyboard navigation          |
| `cell-change`         | `{ row, rowIndex, field, oldValue, newValue }` | Cell value changed (before commit)            |
| `sort-change`         | `{ field, direction }`                       | Sort state changed (0=none, 1=asc, -1=desc)     |
| `column-resize`       | `{ field, width }`                           | Column width changed                            |
| `column-state-change` | `GridColumnState`                            | Column state (widths, order, visibility) changed |

## Methods

```ts
// Wait for grid to be ready
await grid.ready();

// Force layout recalculation
await grid.forceLayout();

// Get current configuration (readonly)
const config = await grid.getConfig();

// Column visibility
grid.setColumnVisible('fieldName', false);
grid.toggleColumnVisibility('fieldName');
const visible = grid.isColumnVisible('fieldName');

// Column state persistence
const state = grid.getColumnState();
grid.columnState = savedState;
grid.resetColumnState();

// Editing
await grid.beginBulkEdit(rowIndex);
await grid.commitActiveRowEdit();
await grid.cancelActiveRowEdit();
await grid.resetChangedRows();
```
