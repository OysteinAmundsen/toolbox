{/* API.mdx */}
import { Meta, ArgTypes } from '@storybook/addon-docs/blocks';

<Meta title="Grid/API" />

# API Reference

Complete reference for the `<tbw-grid>` component API.

## Element Tag

```html
<tbw-grid></tbw-grid>
```

The custom element is registered as `tbw-grid` (Toolbox Web Grid).

## Properties

### Core Data Properties

| Property     | Type             | Default | Description                |
| ------------ | ---------------- | ------- | -------------------------- |
| `rows`       | `T[]`            | `[]`    | Array of row data objects  |
| `columns`    | `ColumnConfig[]` | `[]`    | Column configuration array |
| `gridConfig` | `GridConfig<T>`  | `{}`    | Full configuration object  |

### Layout Properties

| Property  | Type                   | Default     | Description            |
| --------- | ---------------------- | ----------- | ---------------------- |
| `fitMode` | `'stretch' \| 'fixed'` | `'stretch'` | Column sizing strategy |

### Read-only Properties

| Property      | Type                      | Description                   |
| ------------- | ------------------------- | ----------------------------- |
| `changedRows` | `Map<T, ChangedRowEntry>` | Rows with pending edits       |
| `sortState`   | `Map<string, SortState>`  | Current sort state per column |

## HTML Attributes

The grid supports configuration via HTML attributes for declarative usage. JSON-serialized values are used for complex types.

| Attribute     | Maps to Property | Type   | Description                |
| ------------- | ---------------- | ------ | -------------------------- |
| `rows`        | `rows`           | JSON   | Row data as JSON array     |
| `columns`     | `columns`        | JSON   | Column config as JSON array|
| `grid-config` | `gridConfig`     | JSON   | Full config object as JSON |
| `fit-mode`    | `fitMode`        | string | `'stretch'` or `'fixed'`   |

### Example

```html
<tbw-grid
  rows='[{"id":1,"name":"Alice"},{"id":2,"name":"Bob"}]'
  columns='[{"field":"id","header":"ID"},{"field":"name","header":"Name"}]'
  fit-mode="stretch"
>
</tbw-grid>
```

> **Note:** JavaScript property assignment takes precedence over HTML attributes. Removing an attribute does not clear a JS-set value.

## Helper Functions

```typescript
import { createGrid, queryGrid } from '@toolbox-web/grid';

// Create a new grid element with configuration
const grid = createGrid<Employee>({
  columns: [{ field: 'name' }, { field: 'email' }],
  fitMode: 'stretch',
});
document.body.appendChild(grid);
grid.rows = employees;

// Query an existing grid with type safety
const existingGrid = queryGrid<Employee>('#my-grid');
if (existingGrid) {
  existingGrid.rows = newData;
}
```

## Methods

### Data Methods

```typescript
// Update row data
grid.rows = newData;

// Wait for grid to be ready
await grid.ready();

// Force layout recalculation
await grid.forceLayout();

// Get current configuration (readonly)
const config = await grid.getConfig();
```

### Row Update API

The Row Update API provides ID-based access to individual rows for reading and updating data. This is especially useful when you need to update rows after external changes (e.g., API responses, WebSocket events) without replacing the entire dataset.

#### Row Identification

The grid automatically determines row IDs using these sources (in order of precedence):

1. `getRowId` function in gridConfig (custom ID resolution)
2. `id` property on the row object
3. `_id` property on the row object

> **Note:** Rows without any of these will not be accessible via the Row Update API. Calls to `getRow()` or `updateRow()` for such rows will return `undefined` or have no effect.

```typescript
// Configure custom row ID resolution
grid.gridConfig = {
  columns: [...],
  getRowId: (row) => row.employeeId, // Use a custom field as ID
};

// Get a row's ID
const id = grid.getRowId(row);
console.log(id); // "EMP-123"
```

#### Reading Rows

```typescript
// Get a single row by its ID
const employee = grid.getRow('EMP-123');
if (employee) {
  console.log(employee.name);
}

// Returns undefined if the row is not found
const missing = grid.getRow('unknown-id');
console.log(missing); // undefined
```

#### Updating Rows

```typescript
// Update a single row by ID
grid.updateRow('EMP-123', { status: 'active', salary: 75000 });

// Batch update multiple rows
grid.updateRows([
  { id: 'EMP-123', changes: { status: 'active' } },
  { id: 'EMP-456', changes: { department: 'Engineering' } },
]);

// Specify the update source (default: 'api')
// Valid sources: 'user' | 'cascade' | 'api'
grid.updateRow('EMP-123', { status: 'inactive' }, 'api');
grid.updateRows(updates, 'api');
```

#### Listening to Row Updates

The `cell-change` event fires whenever row data is updated via the Row Update API:

```typescript
import type { CellChangeDetail } from '@toolbox-web/grid';

grid.addEventListener('cell-change', (e: CustomEvent<CellChangeDetail>) => {
  const { rowId, changes, source, row } = e.detail;

  console.log(`Row ${rowId} updated via ${source}:`);
  console.log('Changes:', changes); // { status: 'active' }
  console.log('Full row:', row);    // Complete row object after update
});
```

> **Note:** The `cell-change` event is distinct from `cell-commit`, which fires during inline editing. Use `cell-change` for programmatic updates via `updateRow()`/`updateRows()`.

### Column Methods

```typescript
// Get all columns with visibility info
const columns = grid.getAllColumns();
// Returns: Array<{ field, header, visible, lockVisible? }>

// Show/hide columns
grid.setColumnVisible('fieldName', false);
grid.toggleColumnVisibility('fieldName');
grid.showAllColumns();

// Check column visibility
const isVisible = grid.isColumnVisible('fieldName');

// Reorder columns
grid.setColumnOrder(['id', 'name', 'email']);
const order = grid.getColumnOrder();
```

### Editing Methods

```typescript
// Start bulk/row editing programmatically
await grid.beginBulkEdit(rowIndex);

// Commit active row edit
await grid.commitActiveRowEdit();

// Cancel active row edit
await grid.cancelActiveRowEdit();

// Get pending changes (array of changed rows)
const changes = grid.changedRows;

// Get indices of changed rows
const indices = grid.changedRowIndices;

// Reset changed rows tracking
await grid.resetChangedRows();
```

### Plugin Methods

```typescript
import { SelectionPlugin } from '@toolbox-web/grid/plugins/selection';

// Get a registered plugin instance
const selection = grid.getPlugin(SelectionPlugin);

// Check if plugin is registered
if (selection) {
  selection.selectAll();
}
```

### Column State Persistence

```typescript
// Get current column state (for saving)
const state = grid.getColumnState();
localStorage.setItem('gridState', JSON.stringify(state));

// Restore column state
const saved = localStorage.getItem('gridState');
if (saved) {
  grid.columnState = JSON.parse(saved);
}

// Reset to initial configuration
grid.resetColumnState();
```

### Shell Methods (Header/Toolbar)

```typescript
// Register a tool panel
grid.registerToolPanel({
  id: 'myPanel',
  title: 'My Panel',
  icon: '‚öôÔ∏è',
  render: (container) => {
    container.innerHTML = '<div>Panel content</div>';
  },
});

// Open/close/toggle the tool panel sidebar
grid.openToolPanel();
grid.closeToolPanel();
grid.toggleToolPanel();

// Toggle specific accordion sections
grid.toggleToolPanelSection('myPanel');

// Check panel state
const isOpen = grid.isToolPanelOpen;
const sections = grid.expandedToolPanelSections;

// Get registered panels
const panels = grid.getToolPanels();
```

## Events

### Edit Events

| Event                | Detail Type         | Cancelable | Description                         |
| -------------------- | ------------------- | ---------- | ----------------------------------- |
| `cell-commit`        | `CellCommitDetail`  | ‚úÖ Yes     | Cell value was edited (inline)      |
| `cell-change`        | `CellChangeDetail`  | No         | Row updated via Row Update API      |
| `row-commit`         | `RowCommitDetail`   | No         | Bulk row edit completed             |
| `changed-rows-reset` | -                   | No         | Changed rows were reset             |

```typescript
grid.addEventListener('cell-commit', (e: CustomEvent<CellCommitDetail>) => {
  const { row, field, value, oldValue, rowIndex } = e.detail;
  console.log(`Cell ${field} changed from ${oldValue} to ${value}`);

  // Optionally prevent the change
  if (!isValid(value)) {
    e.preventDefault();
  }
});
```

### Sort Events

| Event         | Detail Type        | Description        |
| ------------- | ------------------ | ------------------ |
| `sort-change` | `SortChangeDetail` | Sort state changed |

```typescript
grid.addEventListener('sort-change', (e: CustomEvent<SortChangeDetail>) => {
  const { field, direction, sortState } = e.detail;
  console.log(`Sorted by ${field} ${direction}`);
});
```

### Interaction Events

| Event                 | Detail Type            | Cancelable | Description                                        |
| --------------------- | ---------------------- | ---------- | -------------------------------------------------- |
| `cell-click`          | `CellClickDetail`      | No         | Cell was clicked (after plugin handling)           |
| `row-click`           | `RowClickDetail`       | No         | Row was clicked (after plugin handling)            |
| `cell-activate`       | `CellActivateDetail`   | ‚úÖ Yes     | Cell activated via Enter or click. Check `trigger` |
| `activate-cell`       | `ActivateCellDetail`   | ‚úÖ Yes     | ‚ö†Ô∏è **Deprecated.** Use `cell-activate` instead     |
| `column-resize`       | `ColumnResizeDetail`   | No         | Column was resized                                 |
| `column-state-change` | `GridColumnState`      | No         | Column visibility or order changed                 |

### External Rendering Events

| Event                   | Detail Type                 | Description                      |
| ----------------------- | --------------------------- | -------------------------------- |
| `mount-external-view`   | `ExternalMountViewDetail`   | Request external view renderer   |
| `mount-external-editor` | `ExternalMountEditorDetail` | Request external editor renderer |

### Cancelable Events

Some events are **cancelable**, meaning you can call `event.preventDefault()` to stop the default behavior. This enables validation, conditional blocking, and state rollback scenarios.

#### Core Grid Events

| Event           | Cancelable | Effect when cancelled                          |
| --------------- | ---------- | ---------------------------------------------- |
| `cell-commit`   | ‚úÖ Yes     | Value change is rejected; cell keeps old value |
| `cell-activate` | ‚úÖ Yes     | Cell activation is blocked                     |

#### `cell-commit` ‚Äî Validation Before Save

Use this to validate cell values before they're applied. The event fires **before** the value is written, so calling `preventDefault()` keeps the original value intact.

```typescript
grid.addEventListener('cell-commit', (e: CustomEvent<CellCommitDetail>) => {
  const { field, value, oldValue, row } = e.detail;

  // Example: Prevent negative values in 'salary' field
  if (field === 'salary' && typeof value === 'number' && value < 0) {
    e.preventDefault();
    alert('Salary cannot be negative');
    return;
  }

  // Example: Require manager approval for large changes
  if (field === 'budget' && value > 100000) {
    e.preventDefault();
    showApprovalDialog(row, value);
  }
});
```

#### `cell-activate` ‚Äî Unified Cell Activation

The `cell-activate` event fires when a cell is activated via **Enter key** or **click**. Use the `trigger` property to distinguish between keyboard and pointer activation.

**This event fires BEFORE plugins process the activation**, allowing you to:
- Block editing from starting by calling `e.preventDefault()`
- Prevent selection changes on certain cells
- Implement custom activation logic

```typescript
import type { CellActivateDetail } from '@toolbox-web/grid';

grid.addEventListener('cell-activate', (e: CustomEvent<CellActivateDetail>) => {
  const { rowIndex, colIndex, field, value, row, trigger } = e.detail;

  // Handle both keyboard and pointer activation uniformly
  console.log(`Cell ${field} activated via ${trigger}`);

  // Or differentiate if needed
  if (trigger === 'keyboard') {
    // Enter key pressed
  } else {
    // Click/tap
  }

  // Block activation on locked rows (prevents editing from starting)
  if ((row as any)?.locked) {
    e.preventDefault();
    return;
  }
});
```

> **Note:** The legacy `activate-cell` event is deprecated but still emitted for backwards compatibility. Migrate to `cell-activate` for unified keyboard/pointer handling.

> **Note:** Non-cancelable events like `sort-change` and `column-resize` are informational‚Äîuse column-level flags (`sortable: false`, `resizable: false`) to disable those features entirely.
>
> Plugins may emit their own cancelable events. See individual plugin documentation for details.

## CSS Custom Properties

See the [Theming](../?path=/docs/grid-theming--docs) page for the complete list of CSS custom properties.

### Quick Reference

```css
tbw-grid {
  /* Colors */
  --tbw-color-bg: #ffffff;
  --tbw-color-fg: #333333;
  --tbw-color-border: #e0e0e0;
  --tbw-color-primary: #1976d2;

  /* Header */
  --tbw-header-bg: #f5f5f5;
  --tbw-header-fg: #333333;

  /* Rows */
  --tbw-row-hover-bg: #f0f7ff;
  --tbw-row-selected-bg: #e3f2fd;

  /* Sizing */
  --tbw-row-height: 36px;
  --tbw-header-height: 40px;
}
```

## CSS Parts

```css
tbw-grid::part(container) {
  /* Main container */
}
tbw-grid::part(header) {
  /* Header row */
}
tbw-grid::part(body) {
  /* Body/rows container */
}
```

## TypeScript Types

### Column Configuration

```typescript
interface ColumnConfig {
  field: string; // Data field key
  header?: string; // Display header text
  type?: ColumnType; // 'string' | 'number' | 'boolean' | 'date' | 'select'
  width?: number; // Width in pixels
  minWidth?: number; // Minimum width
  maxWidth?: number; // Maximum width
  sortable?: boolean; // Enable sorting
  resizable?: boolean; // Enable resizing
  editable?: boolean; // Enable editing
  hidden?: boolean; // Initially hidden
  pinned?: 'left' | 'right'; // Pin to edge
  align?: 'left' | 'center' | 'right';

  // Custom rendering
  formatter?: (value: any, row: T) => string;
  renderer?: (value: any, row: T, cell: HTMLElement) => void;

  // Custom header rendering (see Core Grid docs for examples)
  headerLabelRenderer?: (ctx: HeaderLabelContext) => string | HTMLElement;
  headerRenderer?: (ctx: HeaderCellContext) => string | HTMLElement;

  // Dynamic cell styling
  cellClass?: (value: any, row: T, column: ColumnConfig) => string[];

  // Select type options
  options?: Array<{ label: string; value: any }>;
}
```

#### cellClass Callback

Apply dynamic CSS classes to individual cells based on cell value, row data, or column configuration.

```typescript
const columns: ColumnConfig[] = [
  {
    field: 'score',
    header: 'Score',
    cellClass: (value, row, column) => {
      if (value < 30) return ['score-low'];
      if (value > 70) return ['score-high'];
      return ['score-medium'];
    },
  },
  {
    field: 'status',
    header: 'Status',
    cellClass: (value) => [`status-${value}`], // e.g., 'status-active', 'status-pending'
  },
];
```

### Grid Configuration

```typescript
interface GridConfig<T> {
  columns?: ColumnConfig[];
  fitMode?: 'stretch' | 'fixed';
  plugins?: BaseGridPlugin[];
  shell?: ShellConfig;          // Shell header/toolbar/tool panel config
  animation?: AnimationConfig;  // Animation behavior config
  icons?: Partial<GridIcons>;   // Custom icons (SVG strings or emoji)
  getRowId?: (row: T) => string; // Custom row ID resolver
  typeDefaults?: Record<string, TypeDefault<T>>; // Type-level renderer/editor defaults

  // Dynamic row styling
  rowClass?: (row: T) => string[];
}
```

**See Also:**
- [Header Renderers](?path=/docs/grid-core--docs#custom-header-renderers) - Custom column header rendering
- [Shell Components](?path=/docs/grid-core--docs#shell-components) - Toolbar, tool panels, and header bar

#### rowClass Callback

Apply dynamic CSS classes to entire rows based on row data.

```typescript
const config: GridConfig<Employee> = {
  rowClass: (row) => {
    const classes: string[] = [];
    if (!row.active) classes.push('row-inactive');
    if (row.priority === 'high') classes.push('row-priority');
    if (row.role === 'admin') classes.push('row-admin');
    return classes;
  },
};
```

**Notes:**
- Both callbacks return `string[]` (array of class names to apply)
- Empty array `[]` means no dynamic classes
- Classes are automatically cleaned up when row/cell data changes
- Errors in callbacks are caught and logged to console (rendering continues)
- See the [RowClass](?path=/story/grid-core--row-class) and [CellClass](?path=/story/grid-core--cell-class) stories for live demos

#### typeDefaults

Define renderers and editors at the type level, applying to all columns with matching `type`:

```typescript
interface TypeDefault<TRow = unknown> {
  renderer?: ColumnViewRenderer<TRow>;  // Custom cell renderer
  editor?: ColumnEditorSpec<TRow>;      // Custom cell editor
  editorParams?: Record<string, unknown>; // Default editor parameters
}

const config: GridConfig<Employee> = {
  typeDefaults: {
    country: {
      renderer: (ctx) => {
        const span = document.createElement('span');
        span.textContent = `üåç ${ctx.value}`;
        return span;
      },
      editor: (ctx) => {
        const select = document.createElement('select');
        // ... build country dropdown
        return select;
      },
    },
    currency: {
      editorParams: { min: 0, step: 0.01 },
    },
  },
  columns: [
    { field: 'country', type: 'country', editable: true }, // Uses country renderer/editor
    { field: 'salary', type: 'currency', editable: true }, // Uses currency editorParams
  ],
};
```

**Resolution Priority**: Column-level ‚Üí Grid typeDefaults ‚Üí App-level (framework adapter) ‚Üí Built-in

See the [Editing Plugin docs](?path=/docs/grid-plugins-editing--docs#type-level-defaults) for detailed examples.

### Animation Configuration

The grid supports a global animation configuration that controls whether animations run.
Individual plugins define their own animation styles.

```typescript
// Animation behavior mode
type AnimationMode = boolean | 'on' | 'off' | 'reduced-motion';

// Animation style (used by plugins)
type AnimationStyle = 'slide' | 'fade' | 'flip' | false;

// Grid-level animation config
interface AnimationConfig {
  // Global animation mode (default: 'reduced-motion')
  mode?: AnimationMode;

  // Animation duration in ms (default: 200)
  duration?: number;

  // Easing function (default: 'ease-out')
  easing?: string;

  // Style for sorting row changes (core feature, default: false)
  sort?: AnimationStyle;
}
```

#### Animation Modes

| Mode               | Behavior                                                |
| ------------------ | ------------------------------------------------------- |
| `true` / `'on'`    | Animations always enabled                               |
| `false` / `'off'`  | Animations always disabled                              |
| `'reduced-motion'` | Respects `prefers-reduced-motion` media query (default) |

#### Plugin Animation Styles

Each plugin defines its own animation style in its config:

```typescript
// ReorderPlugin - column reordering animation
new ReorderPlugin({ animation: 'flip' }); // 'flip' | 'fade' | false

// MasterDetailPlugin - expand/collapse animation
new MasterDetailPlugin({ animation: 'slide' }); // 'slide' | 'fade' | false

// TreePlugin - tree node expand/collapse
new TreePlugin({ animation: 'slide' }); // 'slide' | 'fade' | false

// GroupingRowsPlugin - group expand/collapse
new GroupingRowsPlugin({ animation: 'slide' }); // 'slide' | 'fade' | false
```

#### CSS Variables

Animation duration and easing are exposed via CSS custom properties:

```css
tbw-grid {
  --tbw-animation-duration: 200ms;
  --tbw-animation-easing: ease-out;
  --tbw-animation-enabled: 1; /* 0 = disabled, 1 = enabled */
}
```

#### Example

```typescript
grid.gridConfig = {
  // Grid-level: enable animations, set timing
  animation: {
    mode: 'on',
    duration: 300,
    easing: 'ease-in-out',
  },
  // Plugin-level: each plugin configures its own style
  plugins: [
    new ReorderPlugin({ animation: 'flip' }),
    new MasterDetailPlugin({ animation: 'slide' }),
    new TreePlugin({ animation: 'fade' }),
  ],
};
```

### Shell Configuration

```typescript
interface ShellConfig {
  header?: ShellHeaderConfig;   // Header bar with title and toolbar
  toolPanel?: ToolPanelConfig;  // Tool panel sidebar settings
}

interface ShellHeaderConfig {
  title?: string;  // Grid title displayed on the left
}

interface ToolPanelConfig {
  position?: 'left' | 'right';  // Panel position (default: 'right')
  width?: number;               // Panel width in pixels (default: 280)
  defaultOpen?: string;         // Panel ID to open by default
}
```

### Icon Customization

```typescript
// Override any grid icon with SVG string or emoji
grid.gridConfig = {
  icons: {
    sortAsc: '‚Üë',
    sortDesc: '‚Üì',
    expand: '+',
    collapse: '‚àí',
    // ... see GridIcons type for all available icons
  },
};
```

### Event Details

```typescript
interface CellCommitDetail<T = any> {
  row: T;
  field: string;
  value: any;
  oldValue: any;
  rowIndex: number;
}

interface CellChangeDetail<T = any> {
  row: T;              // Row object after mutation
  rowId: string;       // Stable row identifier
  rowIndex: number;    // Current index in rows array
  field: string;       // Field that changed
  oldValue: any;       // Value before change
  newValue: any;       // Value after change
  changes: Partial<T>; // All changes passed to updateRow/updateRows
  source: string;      // Origin: 'api', 'websocket', etc.
}

interface SortChangeDetail {
  field: string;
  direction: 'asc' | 'desc' | null;
  sortState: Map<string, SortState>;
}

interface ColumnResizeDetail {
  field: string;
  width: number;
  previousWidth: number;
}
```

## Keyboard Shortcuts

| Shortcut                 | Action                              |
| ------------------------ | ----------------------------------- |
| `‚Üë` `‚Üì` `‚Üê` `‚Üí`          | Navigate between cells              |
| `Enter`                  | Start editing / confirm edit        |
| `Escape`                 | Cancel editing / clear selection    |
| `Tab` / `Shift+Tab`      | Move to next/previous editable cell |
| `Home` / `End`           | Jump to first/last column           |
| `Ctrl+Home` / `Ctrl+End` | Jump to first/last row              |
| `Page Up` / `Page Down`  | Scroll by page                      |
| `F2`                     | Start editing current cell          |

## Browser Support

The grid uses standard Web Components APIs and is compatible with:

- Chrome/Edge 79+
- Firefox 63+
- Safari 13.1+

No polyfills required for modern browsers.
