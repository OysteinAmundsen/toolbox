import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import { Tabs, Tab } from '../../../../../../apps/docs/.storybook/components/Tabs';
import * as PivotStories from './pivot.stories';

<Meta of={PivotStories} />

# Pivot Table Plugin

The Pivot plugin transforms flat data into a pivot table view.

## Installation

```ts
import { PivotPlugin } from '@toolbox-web/grid/plugins/pivot';
```

## Basic Usage

<Tabs>
  <Tab label="Vanilla JS">
```ts
import '@toolbox-web/grid';
import { queryGrid } from '@toolbox-web/grid';
import { PivotPlugin } from '@toolbox-web/grid/plugins/pivot';

const grid = queryGrid('tbw-grid');
grid.gridConfig = {
  columns: [
    { field: 'region', header: 'Region' },
    { field: 'product', header: 'Product' },
    { field: 'quarter', header: 'Quarter' },
    { field: 'sales', header: 'Sales', type: 'number' },
  ],
  plugins: [
    new PivotPlugin({
      rowGroupFields: ['region', 'product'],
      columnGroupFields: ['quarter'],
      valueFields: [{ field: 'sales', aggFunc: 'sum', header: 'Total' }],
    }),
  ],
};
grid.rows = salesData;
```
  </Tab>
  <Tab label="React">
```tsx
import '@toolbox-web/grid-react/features/pivot';
import { DataGrid } from '@toolbox-web/grid-react';

function SalesPivot({ data }) {
  return (
    <DataGrid
      rows={data}
      columns={[
        { field: 'region', header: 'Region' },
        { field: 'product', header: 'Product' },
        { field: 'quarter', header: 'Quarter' },
        { field: 'sales', header: 'Sales', type: 'number' },
      ]}
      pivot={{
        rowGroupFields: ['region', 'product'],
        columnGroupFields: ['quarter'],
        valueFields: [{ field: 'sales', aggFunc: 'sum', header: 'Total' }],
      }}
      style={{ height: '400px' }}
    />
  );
}
```
  </Tab>
  <Tab label="Vue">
```html
<script setup>
import '@toolbox-web/grid-vue/features/pivot';
import { TbwGrid, TbwGridColumn } from '@toolbox-web/grid-vue';

const data = [
  { region: 'North', product: 'Widget', quarter: 'Q1', sales: 1000 },
  { region: 'North', product: 'Gadget', quarter: 'Q1', sales: 1500 },
  { region: 'South', product: 'Widget', quarter: 'Q2', sales: 1200 },
];

const pivotConfig = {
  rowGroupFields: ['region', 'product'],
  columnGroupFields: ['quarter'],
  valueFields: [{ field: 'sales', aggFunc: 'sum', header: 'Total' }],
};
</script>

<template>
  <TbwGrid :rows="data" :pivot="pivotConfig" style="height: 400px">
    <TbwGridColumn field="region" header="Region" />
    <TbwGridColumn field="product" header="Product" />
    <TbwGridColumn field="quarter" header="Quarter" />
    <TbwGridColumn field="sales" header="Sales" type="number" />
  </TbwGrid>
</template>
```
  </Tab>
  <Tab label="Angular">
```typescript
// Feature import - enables the [pivot] input
import '@toolbox-web/grid-angular/features/pivot';

import { Component } from '@angular/core';
import { Grid } from '@toolbox-web/grid-angular';
import type { ColumnConfig } from '@toolbox-web/grid';

@Component({
  selector: 'app-sales-pivot',
  imports: [Grid],
  template: `
    <tbw-grid
      [rows]="rows"
      [columns]="columns"
      [pivot]="pivotConfig"
      style="height: 400px; display: block;">
    </tbw-grid>
  `,
})
export class SalesPivotComponent {
  rows = [...]; // Your sales data

  columns: ColumnConfig[] = [
    { field: 'region', header: 'Region' },
    { field: 'product', header: 'Product' },
    { field: 'quarter', header: 'Quarter' },
    { field: 'sales', header: 'Sales', type: 'number' },
  ];

  pivotConfig = {
    rowGroupFields: ['region', 'product'],
    columnGroupFields: ['quarter'],
    valueFields: [{ field: 'sales', aggFunc: 'sum', header: 'Total' }],
  };
}
```
  </Tab>
</Tabs>

## Demos

### Default Pivot Table

<Canvas of={PivotStories.Default} withToolbar />
<Controls of={PivotStories.Default} />

### Without Totals

<Canvas of={PivotStories.NoTotals} withToolbar />

### Average Aggregation

<Canvas of={PivotStories.AverageAggregation} withToolbar />

## Configuration Options

| Option              | Type                         | Default   | Description                                  |
| ------------------- | ---------------------------- | --------- | -------------------------------------------- |
| `active`            | `boolean`                    | `true`    | Whether pivot is active on load              |
| `rowGroupFields`    | `string[]`                   | `[]`      | Row grouping fields                          |
| `columnGroupFields` | `string[]`                   | `[]`      | Column grouping fields                       |
| `valueFields`       | `ValueField[]`               | `[]`      | Aggregation fields                           |
| `showTotals`        | `boolean`                    | `true`    | Show row totals                              |
| `showGrandTotal`    | `boolean`                    | `true`    | Show grand total                             |
| `showToolPanel`     | `boolean`                    | `true`    | Show pivot tool panel for interactive config |
| `defaultExpanded`   | `boolean`                    | `true`    | Whether groups are expanded by default       |
| `indentWidth`       | `number`                     | `20`      | Indent width per depth level in pixels       |
| `animation`         | `false \| 'slide' \| 'fade'` | `'slide'` | Animation style for expand/collapse          |

## Aggregation Functions

`sum`, `avg`, `count`, `min`, `max`, `first`, `last`

## Programmatic-Only Usage

To use pivot transformation without exposing the tool panel UI to users:

```ts
new PivotPlugin({
  showToolPanel: false,
  rowGroupFields: ['region'],
  columnGroupFields: ['quarter'],
  valueFields: [{ field: 'sales', aggFunc: 'sum' }],
});
```

The pivot API methods remain available for programmatic control.

## Animation

The plugin supports animated expand/collapse transitions. Animation respects the grid-level
`animation.mode` setting and can be customized per-plugin:

```ts
new PivotPlugin({
  rowGroupFields: ['region'],
  valueFields: [{ field: 'sales', aggFunc: 'sum' }],
  animation: 'slide', // 'slide' | 'fade' | false
});
```

Animation is automatically disabled when `animation.mode` is `'off'` or when the user prefers
reduced motion (`'reduced-motion'` mode with system preference).

## Programmatic API

```ts
const plugin = grid.getPlugin(PivotPlugin);

plugin.expandGroup(['North', 'Widget A']);
plugin.collapseGroup(['North']);
plugin.expandAll();
plugin.collapseAll();
```

## Styling

The pivot plugin supports CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-pivot-group-bg` | `var(--tbw-color-row-alt)` | Group row background |
| `--tbw-pivot-group-hover` | `var(--tbw-color-row-hover)` | Group row hover |
| `--tbw-pivot-leaf-bg` | `var(--tbw-color-bg)` | Leaf row background |
| `--tbw-pivot-grand-total-bg` | `var(--tbw-color-header-bg)` | Grand total row |
| `--tbw-pivot-toggle-hover` | `var(--tbw-color-row-hover)` | Toggle button hover |
| `--tbw-pivot-panel-section-bg` | `var(--tbw-color-panel-bg)` | Panel section background |
| `--tbw-toggle-size` | `1.25em` | Toggle button size |
| `--tbw-animation-duration` | `200ms` | Expand/collapse animation |

### Example

```css
tbw-grid {
  /* Custom pivot styling */
  --tbw-pivot-group-bg: #fff3e0;
  --tbw-pivot-grand-total-bg: #ffcc80;
  --tbw-pivot-toggle-hover: #ffe0b2;
}
```

### CSS Classes

The pivot plugin uses these class names:

| Class | Element |
| --- | --- |
| `.pivot-group-row` | Grouped summary row |
| `.pivot-leaf-row` | Detail/leaf row |
| `.pivot-grand-total-row` | Grand total row |
| `.pivot-grand-total-footer` | Sticky footer container |
| `.pivot-toggle` | Expand/collapse button |
| `.pivot-group-label` | Group name display |
| `.tbw-pivot-slide-in` | Row slide animation |
| `.tbw-pivot-fade-in` | Row fade animation |

## See Also

- **[Row Grouping](../?path=/docs/grid-plugins-row-grouping--docs)** — Simple row grouping
- **[Multi-Sort](../?path=/docs/grid-plugins-multi-sort--docs)** — Multi-column sorting
- **[Tree](../?path=/docs/grid-plugins-tree--docs)** — Hierarchical tree data
