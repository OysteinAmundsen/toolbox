import { Meta, Canvas, Controls } from '@storybook/addon-docs/blocks';
import * as PivotStories from './pivot.stories';

<Meta of={PivotStories} />

# Pivot Table Plugin

The Pivot plugin transforms flat data into a pivot table view.

## Installation

```ts
import { PivotPlugin } from '@toolbox-web/grid/plugins/pivot';
```

## Basic Usage

```ts
const grid = document.querySelector('tbw-grid');
grid.gridConfig = {
  columns: [...],
  plugins: [
    new PivotPlugin({
      rowGroupFields: ['region', 'product'],
      columnGroupFields: ['quarter'],
      valueFields: [{ field: 'sales', aggFunc: 'sum', header: 'Total' }],
    }),
  ],
};
```

## Demos

### Default Pivot Table

<Canvas of={PivotStories.Default} withToolbar />
<Controls of={PivotStories.Default} />

### Without Totals

<Canvas of={PivotStories.NoTotals} withToolbar />

### Average Aggregation

<Canvas of={PivotStories.AverageAggregation} withToolbar />

## Configuration Options

| Option              | Type                         | Default   | Description                                  |
| ------------------- | ---------------------------- | --------- | -------------------------------------------- |
| `active`            | `boolean`                    | `true`    | Whether pivot is active on load              |
| `rowGroupFields`    | `string[]`                   | `[]`      | Row grouping fields                          |
| `columnGroupFields` | `string[]`                   | `[]`      | Column grouping fields                       |
| `valueFields`       | `ValueField[]`               | `[]`      | Aggregation fields                           |
| `showTotals`        | `boolean`                    | `true`    | Show row totals                              |
| `showGrandTotal`    | `boolean`                    | `true`    | Show grand total                             |
| `showToolPanel`     | `boolean`                    | `true`    | Show pivot tool panel for interactive config |
| `defaultExpanded`   | `boolean`                    | `true`    | Whether groups are expanded by default       |
| `indentWidth`       | `number`                     | `20`      | Indent width per depth level in pixels       |
| `animation`         | `false \| 'slide' \| 'fade'` | `'slide'` | Animation style for expand/collapse          |

## Aggregation Functions

`sum`, `avg`, `count`, `min`, `max`, `first`, `last`

## Programmatic-Only Usage

To use pivot transformation without exposing the tool panel UI to users:

```ts
new PivotPlugin({
  showToolPanel: false,
  rowGroupFields: ['region'],
  columnGroupFields: ['quarter'],
  valueFields: [{ field: 'sales', aggFunc: 'sum' }],
});
```

The pivot API methods remain available for programmatic control.

## Animation

The plugin supports animated expand/collapse transitions. Animation respects the grid-level
`animation.mode` setting and can be customized per-plugin:

```ts
new PivotPlugin({
  rowGroupFields: ['region'],
  valueFields: [{ field: 'sales', aggFunc: 'sum' }],
  animation: 'slide', // 'slide' | 'fade' | false
});
```

Animation is automatically disabled when `animation.mode` is `'off'` or when the user prefers
reduced motion (`'reduced-motion'` mode with system preference).

## Programmatic API

```ts
const plugin = grid.getPlugin(PivotPlugin);

plugin.expandGroup(['North', 'Widget A']);
plugin.collapseGroup(['North']);
plugin.expandAll();
plugin.collapseAll();
```

## Styling

The pivot plugin supports CSS custom properties for theming. Override these on `tbw-grid` or a parent container:

### CSS Custom Properties

| Property | Default | Description |
| --- | --- | --- |
| `--tbw-pivot-group-bg` | `var(--tbw-color-row-alt)` | Group row background |
| `--tbw-pivot-group-hover` | `var(--tbw-color-row-hover)` | Group row hover |
| `--tbw-pivot-leaf-bg` | `var(--tbw-color-bg)` | Leaf row background |
| `--tbw-pivot-grand-total-bg` | `var(--tbw-color-header-bg)` | Grand total row |
| `--tbw-pivot-toggle-hover` | `var(--tbw-color-row-hover)` | Toggle button hover |
| `--tbw-pivot-panel-section-bg` | `var(--tbw-color-panel-bg)` | Panel section background |
| `--tbw-toggle-size` | `1.25em` | Toggle button size |
| `--tbw-animation-duration` | `200ms` | Expand/collapse animation |

### Example

```css
tbw-grid {
  /* Custom pivot styling */
  --tbw-pivot-group-bg: #fff3e0;
  --tbw-pivot-grand-total-bg: #ffcc80;
  --tbw-pivot-toggle-hover: #ffe0b2;
}
```

### CSS Classes

The pivot plugin uses these class names:

| Class | Element |
| --- | --- |
| `.pivot-group-row` | Grouped summary row |
| `.pivot-leaf-row` | Detail/leaf row |
| `.pivot-grand-total-row` | Grand total row |
| `.pivot-grand-total-footer` | Sticky footer container |
| `.pivot-toggle` | Expand/collapse button |
| `.pivot-group-label` | Group name display |
| `.tbw-pivot-slide-in` | Row slide animation |
| `.tbw-pivot-fade-in` | Row fade animation |
